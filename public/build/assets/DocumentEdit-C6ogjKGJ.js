import{b,j as e,M as w,W as F,n as A,Y as E}from"./app-Bi-kKfSQ.js";import{u as S,a as k,b as y,A as T}from"./Authenticated-C_lZwoKT.js";import{u as O}from"./use-fetch-metadata-CCUa2s-n.js";import{u as P,C as M}from"./Combobox-BOP9bz1U.js";import{S as h}from"./Stack-D9KjGeyZ.js";import{I as U}from"./InputBase-UL63YNSc.js";import{G as D,A as I}from"./NotificationMenu-C937_Mzw.js";import{B as C}from"./Button-1yfY3Uus.js";import{T as v}from"./TextInput-D9HeubEm.js";import{T as g,F as B}from"./OfficeLogo-2ZaB1g-B.js";import{A as L,I as q,u as G,a as N}from"./use-show-items-for-moving-CJy38cXg.js";import{I as Y}from"./IconFolder-cegEoVYR.js";import{I as z}from"./IconFile-BRMhlduA.js";import{I as H}from"./IconEdit-jnnigkmL.js";import{T as V}from"./Textarea-DetDTP7-.js";import{D as W}from"./DatePickerInput-dK0Z6ZZl.js";import"./IconUser-DGEFyDH_.js";import"./Popover-DE1Ul7Ry.js";import"./use-uncontrolled-BwiKmmNw.js";import"./get-sorted-breakpoints-Cse3ButY.js";import"./clamp-DTmYCdls.js";const $=({onAdd:a})=>{const{modals:m,closeModal:n}=S(),l=m.addDocumentMetadata,{metadataList:c}=O(),[d,r]=b.useState(null),u=P({onDropdownClose:()=>u.resetSelectedOption()}),p=()=>{d&&(a(d),n("addDocumentMetadata"),r(null))},_=c.map(o=>e.jsx(M.Option,{value:o.metadata_id.toString(),children:o.name},o.metadata_id));return e.jsx(w,{opened:l,onClose:()=>n("addDocumentMetadata"),title:"Add Custom Metadata",children:e.jsxs(h,{gap:16,children:[e.jsxs(M,{store:u,onOptionSubmit:o=>{const x=c.find(t=>t.metadata_id.toString()===o)||null;r(x),u.closeDropdown()},children:[e.jsx(M.Target,{children:e.jsx(U,{component:"button",type:"button",rightSection:e.jsx(M.Chevron,{}),onClick:()=>u.toggleDropdown(),children:d?d.name:"Select Metadata"})}),e.jsx(M.Dropdown,{children:e.jsx(M.Options,{children:_})})]}),e.jsxs(D,{justify:"flex-end",children:[e.jsx(C,{variant:"outline",onClick:()=>n("addDocumentMetadata"),children:"Cancel"}),e.jsx(C,{onClick:p,disabled:!d,children:"Add"})]})]})})},J=({metadata:a,requiredMetadata:m,onAdd:n,onUpdate:l,onChange:c,onDelete:d})=>{const{openModal:r}=S(),u=t=>{n&&n(t)},p=()=>{r("addDocumentMetadata")},_=t=>{const i=a[t],j=a.filter((s,f)=>f!==t);l&&l(j),d&&i.metadata_id!==0&&d(i.metadata_id)},o=(t,i,j)=>{const s=a.map((f,R)=>R===t?{...f,[i]:j}:f);c&&c(s)},x=b.useMemo(()=>{const t=a.map(i=>i.metadata_id);return m.filter(i=>!t.includes(i.metadata_id))},[a,m]);return e.jsxs(h,{children:[a.map((t,i)=>e.jsxs(D,{grow:!0,align:"flex-end",children:[e.jsx(v,{disabled:!0,label:"Name",placeholder:"Metadata name",value:t.name,onChange:j=>o(i,"name",j.target.value)}),e.jsx(v,{label:"Value",placeholder:"Metadata value",value:t.value,onChange:j=>o(i,"value",j.target.value)}),e.jsx(I,{color:"red",onClick:()=>_(i),children:e.jsx(k,{size:16})})]},t.metadata_id||i)),x.length>0&&e.jsxs(h,{gap:"xs",children:[e.jsx(g,{c:"red",size:"sm",children:"Missing Required Metadata:"}),x.map(t=>e.jsx(L,{icon:e.jsx(q,{size:16}),title:`${t.name} is missing`,color:"red",variant:"light"},t.metadata_id))]}),e.jsx(C,{variant:"light",onClick:p,leftSection:e.jsx(y,{size:14}),children:"Add Custom Metadata"}),e.jsx($,{onAdd:t=>u({metadata_id:t.metadata_id,name:t.name,value:""})})]})},K=({onAdd:a})=>{const{modals:m,closeModal:n}=S(),l=m.relatedDocumentModal,[c,d]=b.useState(null),{data:r,loading:u,error:p}=G(c,l);console.log("related document modal data",r);const _=t=>{d(t)},o=()=>{r.itemParent&&r.itemParent.parent_id?d(r.itemParent.parent_id):d(null)},x=t=>{a(t),n("relatedDocumentModal"),d(null)};return e.jsx(w,{opened:l,onClose:()=>n("relatedDocumentModal"),title:"Select Related Document",size:"lg",children:e.jsxs(h,{gap:"md",children:[e.jsxs(D,{children:[c&&e.jsx(I,{onClick:o,children:e.jsx(N,{size:16})}),e.jsx(g,{children:"Select a document to relate"})]}),u?e.jsx(g,{children:"Loading..."}):p?e.jsx(g,{c:"red",children:p}):e.jsx(h,{style:{maxHeight:400,overflowY:"auto"},children:r.itemContents.map(t=>e.jsxs(D,{style:{cursor:"pointer"},onClick:()=>{t.type==="folder"?_(t.item_id):x({item_id:t.item_id,name:t.name})},children:[t.type==="folder"?e.jsx(Y,{}):e.jsx(z,{}),e.jsx(g,{children:t.name})]},t.item_id))})]})})},Q=({relatedDocuments:a,onChange:m})=>{const{openModal:n}=S(),l=d=>{const r=[...a,d];m&&m(r)},c=d=>{const r=a.filter((u,p)=>p!==d);m&&m(r)};return e.jsxs(h,{children:[a.map((d,r)=>e.jsxs(D,{grow:!0,align:"center",children:[e.jsx(g,{children:d.name}),e.jsx(I,{color:"red",onClick:()=>c(r),children:e.jsx(k,{size:16})})]},d.item_id)),e.jsx(K,{onAdd:l}),e.jsx(C,{variant:"light",onClick:()=>n("relatedDocumentModal"),leftSection:e.jsx(y,{size:14}),children:"Add Related Document"})]})};function X({document:a,onSuccess:m}){const{data:n,setData:l,put:c,processing:d,errors:r,reset:u,clearErrors:p}=F({name:a.name,document_number:a.document_number||"",description:a.description||"",due_date:a.due_date||"",update_metadata:a.metadata.map(o=>({metadata_id:o.metadata_id,name:o.name,value:o.value})),delete_metadata:[],related_documents:a.related_documents.map(o=>({item_id:o.item_id,name:o.name}))});return{data:n,setData:l,handleUpdateDocument:o=>{o.preventDefault(),c(route("document.save",a.item_id),{onSuccess:()=>{A.show({message:"Document updated successfully",color:"green"})},onError:x=>{A.show({message:"Failed to update document",color:"red"})},onFinish:()=>p()})},processing:d,errors:r,reset:u}}function Me({document:a,itemAncestors:m}){const{data:n,setData:l,handleUpdateDocument:c,processing:d,errors:r,reset:u}=X({document:a}),[p,_]=b.useState([]),o=s=>{l("update_metadata",[...n.update_metadata||[],s])},x=s=>{n.update_metadata=s},t=s=>{l("update_metadata",s)},i=s=>{_(f=>[...f,s]),l("delete_metadata",[...n.delete_metadata||[],{metadata_id:s}])},j=s=>{l("related_documents",s)};return e.jsxs(T,{children:[e.jsx(E,{title:"Document Properties"}),e.jsxs(h,{px:8,py:8,gap:24,w:550,mb:72,children:[e.jsxs(D,{mt:24,align:"center",children:[e.jsx(z,{size:56,stroke:1.5,color:"gray"}),e.jsx(g,{fw:500,children:n.name}),e.jsx(I,{variant:"subtle",color:"gray",children:e.jsx(H,{size:24})})]}),e.jsxs("form",{onSubmit:c,children:[e.jsxs(h,{gap:12,children:[e.jsx(v,{label:"Document Number",name:"document_number",value:n.document_number,onChange:s=>l("document_number",s.target.value),placeholder:"Enter document number"}),e.jsx(v,{type:"text",label:"Created At",value:a.created_at,disabled:!0}),e.jsx(V,{label:"Description",autosize:!0,minRows:4,maxRows:6,placeholder:"Enter description",value:n.description,onChange:s=>l("description",s.target.value)}),e.jsx(W,{label:"Due Date",placeholder:"Select due date",value:n.due_date?new Date(n.due_date):void 0,onChange:s=>l("due_date",(s==null?void 0:s.toISOString())??void 0)})]}),e.jsxs(h,{gap:12,children:[e.jsx(g,{size:"sm",fw:500,children:"Custom Metadata Field"}),e.jsx(J,{metadata:n.update_metadata??[],requiredMetadata:a.required_folder_metadata,onAdd:o,onUpdate:x,onChange:t,onDelete:i})]}),e.jsxs(h,{gap:12,children:[e.jsx(g,{size:"sm",fw:500,children:"Related Documents"}),e.jsx(Q,{relatedDocuments:n.related_documents||[],onChange:j})]}),e.jsxs(B,{align:"center",justify:"end",mt:16,children:[e.jsx(C,{variant:"light",onClick:()=>u(),children:"Cancel"}),e.jsx(C,{ml:12,type:"submit",loading:d,children:"Save Changes"})]})]})]})]})}export{Me as default};
