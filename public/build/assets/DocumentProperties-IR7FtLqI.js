import{b as _,u as Q,h as X,j as e,i as Z,W as M,n as y,M as $,c as q,Y as ee,B as se,P as re}from"./app-COI09GEu.js";import{u as E,a as B,b as P,T as te,A as oe}from"./Authenticated-BOJpYSul.js";import{Y}from"./index-Cde5U0I6.js";import{I as le}from"./ItemBreadcrumbs-CkaQ1NsD.js";import{u as H,R as T,a as ne,I as ae,b as ce,c as ie}from"./use-fetch-users-CfTtha39.js";import{T as w,F as W}from"./OfficeLogo-BJbDsiR3.js";import{S as N}from"./Stack-C5mar0nD.js";import{G as R,A as V,S as de}from"./NotificationMenu-BHakjobV.js";import{T as L}from"./Textarea-BW6s4n7T.js";import{S as O}from"./Select-B2FaHH1o.js";import{B as A}from"./Button-dB9HwxwG.js";import{c as J}from"./IconUser-BqOjfF9G.js";import{I as ue}from"./IconDownload-Dg6IkT6j.js";import{G}from"./Grid-BhGtGtEI.js";import{I as pe}from"./IconFile-BQOFS9p3.js";import"./TextInput-COZo1gMD.js";import"./InputBase-CZftOjEr.js";import"./Popover-Cvv-QQda.js";import"./use-uncontrolled-tqWMHqn9.js";import"./get-sorted-breakpoints-BcrXOVSI.js";import"./Checkbox-DUXX-WQp.js";import"./CheckIcon-D2W1QFc3.js";import"./Anchor-D0PcmEFH.js";import"./Combobox-B-mose7B.js";import"./get-base-value-JqT_q0U7.js";const me={multiple:!1},K=_.forwardRef((s,o)=>{const{onChange:t,children:r,multiple:l,accept:a,name:n,form:f,resetRef:m,disabled:j,capture:b,inputProps:z,...d}=Q("FileButton",me,s),D=_.useRef(),x=()=>{var p;!j&&((p=D.current)==null||p.click())},g=p=>{t(l?Array.from(p.currentTarget.files):p.currentTarget.files[0]||null)};return X(m,()=>{D.current.value=""}),e.jsxs(e.Fragment,{children:[r({onClick:x,...d}),e.jsx("input",{style:{display:"none"},type:"file",accept:a,multiple:l,onChange:g,ref:Z(o,D),name:n,form:f,capture:b,...z})]})});K.displayName="@mantine/core/FileButton";/**
 * @license @tabler/icons-react v3.11.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var he=J("outline","eye","IconEye",[["path",{d:"M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0",key:"svg-0"}],["path",{d:"M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.11.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ve=J("outline","refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]]);function fe({documentId:s}){const[o,t]=_.useState("reviewal"),{closeModal:r,modals:l}=E(),a=H(o,l.createDocumentApproval),{data:n,setData:f,post:m,processing:j,errors:b,reset:z}=M({document_id:"",resolution:"",destination:"",type:"reviewal",users:[]}),[d,D]=_.useState([]),x=a.length;_.useEffect(()=>{D([])},[o,a]);const g=U=>{U.preventDefault();const C=d.map(i=>parseInt(i.selectedUser)).filter(i=>!isNaN(i));n.document_id=s??"",n.users=C.map(i=>({user_id:i.toString()})),m(route("document_approvals.store"),{preserveScroll:!0,onSuccess:()=>{r("createDocumentApproval"),y.show({message:"Document approval process created",color:"green"})},onError:()=>{y.show({message:"Something went wrong",color:"red"})},onFinish:()=>z()})},u=()=>{d.length<x&&D([...d,{selectedUser:""}])},p=()=>{const U=d.map(c=>c.selectedUser),i=a.filter(c=>!U.includes(c.id.toString())).map(c=>({selectedUser:c.id.toString()}));D([...d,...i])},h=U=>{const C=[...d];C.splice(U,1),D(C)},v=(U,C)=>{const i=[...d];i[U].selectedUser=C||"",D(i)},k=d.map(U=>U.selectedUser).filter(U=>U!=="");return{data:n,setData:f,createApprovalSubmit:g,processing:j,errors:b,users:d,setDocumentApprovalType:t,addUser:u,removeUser:h,handleUserChange:v,addAllUsers:p,maxUsers:x,selectedUserIds:k,fetchedUsers:a}}const ge=({document:s})=>{const{data:o,setData:t,createApprovalSubmit:r,processing:l,errors:a,users:n,setDocumentApprovalType:f,addUser:m,removeUser:j,handleUserChange:b,addAllUsers:z,maxUsers:d,selectedUserIds:D,fetchedUsers:x}=fe({documentId:s==null?void 0:s.item_id}),{modals:g,closeModal:u}=E(),p=h=>x.filter(v=>!D.includes(v.id.toString())||v.id.toString()===n[h].selectedUser).map(v=>({value:v.id.toString(),label:`${v.name} (${v.email})`}));return e.jsx($,{opened:g.createDocumentApproval,onClose:()=>u("createDocumentApproval"),title:e.jsx(w,{fw:"bold",size:"lg",children:"Create Document Approval Process"}),size:550,children:e.jsxs("form",{onSubmit:r,children:[e.jsxs(N,{gap:16,children:[e.jsx(w,{size:"sm",color:"dimmed",children:"Routinely directs any uploaded file in this folder through a predefined document approval process"}),e.jsx(T.Group,{name:"status",value:o.type,onChange:h=>{t("type",h),f(h)},children:e.jsxs(R,{mt:"xs",children:[e.jsx(T,{value:"reviewal",label:"Review"}),e.jsx(T,{value:"approval",label:"Approval"})]})}),e.jsx(L,{label:"Resolution",placeholder:"Your resolution for this approval",value:o.resolution??"",onChange:h=>t("resolution",h.target.value),error:a.resolution,autosize:!0,minRows:2,maxRows:4}),e.jsx(w,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),n.map((h,v)=>e.jsxs(R,{justify:"space-between",align:"flex-end",children:[e.jsx(O,{placeholder:"Select a user",data:p(v),value:h.selectedUser,onChange:k=>b(v,k),required:!0,style:{flex:1},allowDeselect:!1}),e.jsx(V,{color:"red",onClick:()=>j(v),title:"Remove User",children:e.jsx(B,{size:18})})]},v)),e.jsxs(R,{children:[n.length<d&&e.jsx(A,{variant:"subtle",color:"green",leftSection:e.jsx(P,{size:16}),onClick:m,disabled:n.length>=d,children:"Add User"}),D.length<d&&e.jsx(A,{variant:"subtle",color:"blue",leftSection:e.jsx(P,{size:16}),onClick:z,disabled:n.length>=d,children:"Add All Users"})]})]}),e.jsxs(W,{align:"center",justify:"end",mt:16,children:[e.jsx(A,{variant:"light",onClick:()=>u("createDocumentApproval"),children:"Cancel"}),e.jsx(A,{ml:12,type:"submit",loading:l,children:"Create"})]})]})})};function je({documentApprovalId:s,isOpen:o}){const[t,r]=_.useState(null);_.useEffect(()=>{s&&o&&l(s)},[s,o]);const l=async a=>{try{const n=await q.get(`/document_approval/${a}/update`);r(n.data)}catch(n){console.error("Error fetching document approval",n)}};return t}function xe({documentApprovalId:s,isOpen:o}){const[t,r]=_.useState("reviewal"),l=je({documentApprovalId:s,isOpen:o}),a=H(t,o),{closeModal:n}=E(),{data:f,setData:m,put:j,processing:b,errors:z,reset:d,clearErrors:D}=M({resolution:"",type:"",users:[]}),[x,g]=_.useState([]),u=a.length;_.useEffect(()=>{l&&(r(l.type||""),m({resolution:l.resolution||"",type:l.type||"",users:(l.document_user_approvals||[]).map(c=>({user_id:c.user_id}))}),g((l.document_user_approvals||[]).map(c=>({selectedUser:c.user_id.toString()}))))},[l,o]),_.useEffect(()=>{g([])},[t]);const p=()=>{n("viewDocumentApproval"),d(),D()},h=c=>{c.preventDefault(),f.users=x.map(S=>parseInt(S.selectedUser)).filter(S=>!isNaN(S)).map(S=>({user_id:S.toString()})),j(route("document_approvals.update",s),{onSuccess:()=>{p(),y.show({message:"Document approval updated successfully",color:"green"})},onError:()=>{y.show({message:"Something went wrong",color:"red"})},onFinish:()=>d()})},v=()=>{x.length<u&&g([...x,{selectedUser:""}])},k=()=>{const c=x.map(I=>I.selectedUser),F=a.filter(I=>!c.includes(I.id.toString())).map(I=>({selectedUser:I.id.toString()}));g([...x,...F])},U=c=>{const S=[...x];S.splice(c,1),g(S)},C=(c,S)=>{const F=[...x];F[c].selectedUser=S||"",g(F)},i=x.map(c=>c.selectedUser).filter(c=>c!=="");return{data:f,setData:m,handleUpdateDocumentApproval:h,processing:b,errors:z,handleClose:p,users:x,documentApproval:l,setDocumentApprovalType:r,addUser:v,removeUser:U,handleUserChange:C,addAllUsers:k,maxUsers:u,selectedUserIds:i,fetchedUsers:a}}function Ue({documentApprovalId:s,onDeleteSuccess:o}){const{delete:t,processing:r}=M();return{handleDeleteDocumentApproval:()=>{if(!s){y.show({message:"Document Approval ID is missing.",color:"red"});return}t(route("document_approvals.cancel",s),{onSuccess:()=>{y.show({message:"Document Approval deleted successfully.",color:"green"}),o()},onError:a=>{let n="Failed to delete document approval.";a&&Object.keys(a).length>0&&(n=a[Object.keys(a)[0]]),y.show({message:n,color:"red"})}})},processing:r}}const De=({documentApprovalId:s})=>{const{modals:o,closeModal:t,openModal:r}=E(),l=o.confirmDeleteDocumentApproval,{handleDeleteDocumentApproval:a,processing:n}=Ue({documentApprovalId:s,onDeleteSuccess:()=>{t("confirmDeleteDocumentApproval"),t("viewDocumentApproval")}});return e.jsxs($,{opened:l,onClose:()=>t("confirmDeleteDocumentApproval"),title:e.jsx(w,{fw:"bold",size:"lg",children:"Confirm Delete"}),size:"sm",centered:!0,children:[e.jsx(w,{c:"gray.8",children:"Are you sure you want to cancel this document approval? This action cannot be undone."}),e.jsxs(W,{align:"center",justify:"flex-end",mt:16,children:[e.jsx(A,{variant:"light",onClick:()=>{t("confirmDeleteDocumentApproval"),r("viewDocumentApproval")},children:"Cancel"}),e.jsx(A,{color:"red",ml:12,onClick:a,loading:n,children:"Delete"})]})]})},we=({document:s})=>{const{modals:o,closeModal:t,openModal:r}=E(),l=o.viewDocumentApproval,{data:a,setData:n,handleUpdateDocumentApproval:f,processing:m,errors:j,users:b,setDocumentApprovalType:z,addUser:d,removeUser:D,handleUserChange:x,addAllUsers:g,documentApproval:u,maxUsers:p,selectedUserIds:h,fetchedUsers:v}=xe({documentApprovalId:s==null?void 0:s.document_approval_id,isOpen:l}),k=i=>v.filter(c=>!h.includes(c.id.toString())||c.id.toString()===b[i].selectedUser).map(c=>({value:c.id.toString(),label:`${c.name} (${c.email})`})),U=u==null?void 0:u.document_user_approvals.some(i=>["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(i.user_state)),C=u==null?void 0:u.document_user_approvals.every(i=>["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(i.user_state));return e.jsxs(e.Fragment,{children:[e.jsx($,{opened:l,onClose:()=>t("viewDocumentApproval"),title:e.jsx(w,{fw:"bold",size:"lg",children:"Document Workflow Process"}),size:550,children:e.jsxs("form",{onSubmit:f,children:[e.jsxs(N,{gap:16,children:[e.jsx(w,{size:"sm",children:"View the document workflow process for this document"}),!U&&e.jsx(T.Group,{name:"status",value:a.type,onChange:i=>{n("type",i),z(i)},children:e.jsxs(R,{mt:"xs",children:[e.jsx(T,{value:"reviewal",label:"Review"}),e.jsx(T,{value:"approval",label:"Approval"})]})}),e.jsx(L,{label:"Resolution",placeholder:"Your resolution for this approval",value:a.resolution??"",onChange:i=>n("resolution",i.target.value),error:j.resolution,autosize:!0,minRows:2,maxRows:4,readOnly:U}),e.jsx(w,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),b.map((i,c)=>{const S=u==null?void 0:u.document_user_approvals.find(I=>I.user_id.toString()===i.selectedUser),F=S&&["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(S.user_state);return e.jsxs(R,{justify:"space-between",align:"flex-end",children:[e.jsxs(R,{children:[e.jsx(de,{approvalStatus:S==null?void 0:S.user_state})," "]}),e.jsx(O,{placeholder:"Select a user",data:k(c),value:i.selectedUser,onChange:I=>x(c,I),required:!F,style:{flex:1},allowDeselect:!F,readOnly:F}),!F&&e.jsx(V,{color:"red",onClick:()=>D(c),title:"Remove User",children:e.jsx(B,{size:18})})]},c)}),!C&&e.jsxs(R,{children:[b.length<p&&e.jsx(A,{variant:"subtle",color:"green",leftSection:e.jsx(P,{size:16}),onClick:d,disabled:b.length>=p,children:"Add User"}),h.length<p&&e.jsx(A,{variant:"subtle",color:"blue",leftSection:e.jsx(P,{size:16}),onClick:g,disabled:b.length>=p,children:"Add All Users"})]})]}),e.jsxs(W,{align:"center",justify:"end",mt:16,children:[e.jsx(A,{variant:"light",onClick:()=>t("viewDocumentApproval"),children:C?"Close":"Cancel"}),!C&&e.jsxs(e.Fragment,{children:[e.jsx(A,{ml:12,type:"submit",loading:m,children:"Update"}),e.jsx(V,{variant:"transparent",color:"red",onClick:()=>{t("viewDocumentApproval"),r("confirmDeleteDocumentApproval")},title:"Delete Document Approval",ml:12,children:e.jsx(B,{size:18})})]})]})]})}),e.jsx(De,{documentApprovalId:s==null?void 0:s.document_approval_id})]})};function Ae(){const{post:s,processing:o}=M();return{restoreVersion:r=>{s(route("document.restore_version",{version:r}),{onSuccess:()=>{y.show({message:"Document version restored successfully.",color:"green"})},onError:()=>{y.show({message:"Failed to restore document version.",color:"red"})}})},processing:o}}function be(){const{delete:s,processing:o}=M();return{deleteVersion:r=>{s(route("document.delete_version",{version:r}),{onSuccess:()=>{y.show({message:"Document version deleted successfully.",color:"green"})},onError:()=>{y.show({message:"Failed to delete document version.",color:"red"})}})},processing:o}}const Se=({versions:s})=>{const{restoreVersion:o}=Ae(),{deleteVersion:t}=be();return e.jsx(Y,{columns:[{accessor:"name",title:"Name"},{accessor:"uploaded_at",title:"Uploaded At"},{accessor:"actions",title:"Actions",render:r=>e.jsxs(R,{gap:4,children:[e.jsx(V,{variant:"subtle",onClick:()=>o(r.id),children:e.jsx(ve,{size:16})}),e.jsx(V,{variant:"subtle",color:"red",onClick:()=>t(r.id),children:e.jsx(B,{size:16})}),e.jsx("a",{href:r.file_path,download:!0,children:e.jsx(V,{variant:"subtle",children:e.jsx(ue,{size:16})})})]})}],records:s,highlightOnHover:!0,verticalSpacing:"sm",horizontalSpacing:"sm"})};function ye(s){const{data:o,post:t,reset:r,processing:l,errors:a,clearErrors:n}=M({document_item_id:s,file:null});return{uploadVersion:m=>{if(!m){y.show({message:"No file selected.",color:"red"});return}o.file=m,t(`/document/${s}/versions`,{onSuccess:()=>{y.show({message:"Document version uploaded successfully.",color:"green"}),r()},onError:()=>{y.show({message:"Failed to upload document version.",color:"red"})},onFinish:()=>{n()}})},processing:l,errors:a}}function Ce({documentId:s,isOpen:o}){const[t,r]=_.useState([]),[l,a]=_.useState(!1),[n,f]=_.useState(null);return _.useEffect(()=>{s&&(async()=>{a(!0);try{const j=await q.get(route("document.fetchSharedUsers",{document:s}));r(j.data),f(null)}catch(j){console.error(j),f("Failed to fetch shared users."),y.show({title:"Error",message:"Unable to fetch shared users.",color:"red"})}finally{a(!1)}})()},[s,o]),{sharedUsers:t,loading:l,error:n}}function _e({documentId:s,close:o}){const{modals:t}=E(),r=t.shareDocument,{sharedUsers:l,loading:a,error:n}=Ce({documentId:s,isOpen:r}),{data:f,setData:m,post:j,processing:b,errors:z,reset:d}=M({users:[]});return _.useEffect(()=>{if(l.length>0){const h=l.map(v=>({email:v.email,role:v.role}));m("users",h)}},[l]),{data:f,submit:()=>{j(route("document.share",{document:s}),{onSuccess:()=>{o(),y.show({message:"Document shared successfully.",color:"green"}),d()},onError:h=>{y.show({message:"Failed to share the document.",color:"red"})}})},processing:b,errors:z,addUser:()=>{m("users",[...f.users,{email:"",role:"viewer"}])},removeUser:h=>{const v=f.users.filter((k,U)=>U!==h);m("users",v)},handleUserChange:(h,v,k)=>{const U=f.users.map((C,i)=>i===h?{...C,[v]:k}:C);m("users",U)},handleAddAllUsers:h=>{m("users",h)}}}const ze=({documentId:s})=>{const{modals:o,closeModal:t}=E(),{users:r,loading:l,error:a}=ne(),{data:n,submit:f,processing:m,errors:j,addUser:b,removeUser:z,handleUserChange:d,handleAddAllUsers:D}=_e({documentId:s,close:()=>t("shareDocument")}),x=()=>{const g=r.map(u=>({email:u.email,role:"viewer"}));D(g)};return e.jsx($,{opened:o.shareDocument,onClose:()=>t("shareDocument"),title:e.jsx(w,{size:"lg",children:"Share Document"}),size:"600",children:e.jsxs("form",{onSubmit:g=>{g.preventDefault(),f()},children:[e.jsxs(N,{children:[n.users.map((g,u)=>e.jsxs(R,{align:"flex-end",children:[e.jsx(O,{data:r.map(p=>({value:p.email,label:`${p.name} (${p.email})`})),placeholder:"Select a user",value:g.email,onChange:p=>d(u,"email",p||""),style:{flex:1},required:!0}),e.jsx(O,{data:[{value:"viewer",label:"Viewer"},{value:"editor",label:"Editor"}],placeholder:"Select role",value:g.role,onChange:p=>d(u,"role",p||"viewer"),style:{width:120},required:!0}),e.jsx(te,{label:"Remove User",withArrow:!0,children:e.jsx(V,{color:"red",onClick:()=>z(u),children:e.jsx(B,{size:18})})})]},u)),e.jsxs(R,{children:[e.jsx(A,{variant:"subtle",color:"green",leftSection:e.jsx(P,{size:16}),onClick:()=>b(),children:"Add User"}),e.jsx(A,{variant:"subtle",color:"blue",leftSection:e.jsx(P,{size:16}),onClick:x,disabled:n.users.length>=r.length,children:"Add All Users"})]})]}),e.jsxs(R,{mt:"md",children:[e.jsx(A,{variant:"outline",onClick:()=>t("shareDocument"),children:"Cancel"}),e.jsx(A,{type:"submit",loading:m,children:"Save"})]})]})})},ss=({document:s,itemAncestors:o,activityLog:t,userRole:r})=>{const{openModal:l}=E(),{uploadVersion:a,processing:n,errors:f}=ye(s.item_id),m=j=>{j&&a(j)};return e.jsxs(oe,{children:[e.jsx(ee,{title:"Document Properties"}),e.jsx(se,{px:8,py:8,mb:48,children:e.jsx(le,{ancestors:o})}),e.jsxs(G,{children:[e.jsx(G.Col,{span:8,children:e.jsxs(N,{px:8,py:8,gap:48,mb:48,children:[e.jsxs(R,{children:[e.jsx(pe,{size:56,stroke:1,color:"gray"}),e.jsx(w,{fw:500,children:s.name})]}),e.jsxs(R,{justify:"space-between",w:700,children:[e.jsxs("div",{children:[e.jsx(w,{size:"sm",fw:"bold",children:"Document ID"}),e.jsx(w,{size:"sm",children:s.item_id})]}),e.jsxs("div",{children:[e.jsx(w,{size:"sm",fw:"bold",children:"Date"}),e.jsx(w,{size:"sm",children:s.created_at})]}),e.jsxs("div",{children:[e.jsx(w,{size:"sm",fw:"bold",children:"Document Number"}),e.jsx(w,{size:"sm",children:s.document_number})]})]}),e.jsxs(N,{gap:12,children:[s.versions.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(w,{size:"sm",fw:"bold",children:"Document Versions"}),e.jsx(Se,{versions:s.versions})]}),e.jsx(w,{size:"sm",fw:"bold",children:"Audit Log"}),e.jsx(Y,{textSelectionDisabled:!0,columns:[{accessor:"date"},{accessor:"time"},{accessor:"user_name",title:"User"},{accessor:"description",title:"Action"}],records:t,highlightOnHover:!0,verticalSpacing:"lg",horizontalSpacing:"xl",withTableBorder:!0})]})]})}),e.jsx(G.Col,{span:3,offset:1,children:e.jsxs(re,{withBorder:!0,p:20,children:[e.jsx(w,{c:"dimmed",fw:500,children:"Options"}),(r==="editor"||r==="admin")&&e.jsx(K,{onChange:m,children:j=>e.jsx(A,{...j,variant:"subtle",color:"blue.5",fullWidth:!0,justify:"left",leftSection:e.jsx(ae,{size:18}),children:"Upload New Version"})}),(r==="editor"||r==="admin")&&e.jsxs(A,{variant:"subtle",color:"blue.5",leftSection:e.jsx(ce,{size:18}),fullWidth:!0,justify:"left",onClick:()=>{l(s.document_approval_id?"viewDocumentApproval":"createDocumentApproval")},children:[s.document_approval_id?"View":"Start"," Approval Process"]}),e.jsx(A,{variant:"subtle",component:"a",href:route("document.view",{document:s.item_id}),target:"_blank",color:"blue.5",leftSection:e.jsx(he,{size:18}),justify:"left",fullWidth:!0,children:"View Document"}),(r==="editor"||r==="admin")&&e.jsx(A,{variant:"subtle",color:"blue.5",leftSection:e.jsx(ie,{size:18}),fullWidth:!0,justify:"left",onClick:()=>l("shareDocument"),children:"Share Document"})]})})]}),e.jsx(ge,{document:s}),e.jsx(we,{document:s}),e.jsx(ze,{documentId:s.item_id})]})};export{ss as default};
