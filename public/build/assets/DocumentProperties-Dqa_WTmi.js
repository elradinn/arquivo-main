import{b as C,u as J,h as K,j as e,i as Q,W as E,n as w,M as G,c as X,Y as Z,B as ee,P as se}from"./app-DlxKuYZb.js";import{u as M,a as P,b as B,A as re}from"./Authenticated-DheR4sxi.js";import{Y}from"./index-DTmPIedb.js";import{I as oe}from"./ItemBreadcrumbs-BIMJMaDC.js";import{u as W,R as V,I as te,a as ne}from"./use-fetch-users-approval-role-DOAe3arA.js";import{T as v,F as $}from"./OfficeLogo-DbkgrjPw.js";import{S as N}from"./Stack-L1pcLF8o.js";import{G as _,A as T,S as le}from"./NotificationMenu-Ce37Wr51.js";import{T as q}from"./Textarea-BqthKAHv.js";import{S as H}from"./Select-nPdKmNfd.js";import{B as S}from"./Button-Dfv1i1zu.js";import{c as ae}from"./IconUser-Une0tFzg.js";import{I as ce}from"./IconDownload-B8tpnwxA.js";import{G as O}from"./Grid-rk7KtSj0.js";import{I as ie}from"./IconFile-BbAhdAXo.js";import"./TextInput-RGh6OL0q.js";import"./InputBase-Dv4EAKYT.js";import"./Popover-DtfI_0xr.js";import"./use-uncontrolled-CAowUEhF.js";import"./get-sorted-breakpoints-D-XbkWVB.js";import"./Checkbox-BKToS-RO.js";import"./CheckIcon-Cer5X6RL.js";import"./Anchor-D9Srbwko.js";import"./Combobox-BF7Om7To.js";import"./get-base-value-JqT_q0U7.js";const de={multiple:!1},L=C.forwardRef((s,t)=>{const{onChange:o,children:n,multiple:a,accept:c,name:l,form:A,resetRef:p,disabled:R,capture:b,inputProps:z,...d}=J("FileButton",de,s),x=C.useRef(),u=()=>{var f;!R&&((f=x.current)==null||f.click())},U=f=>{o(a?Array.from(f.currentTarget.files):f.currentTarget.files[0]||null)};return K(p,()=>{x.current.value=""}),e.jsxs(e.Fragment,{children:[n({onClick:u,...d}),e.jsx("input",{style:{display:"none"},type:"file",accept:c,multiple:a,onChange:U,ref:Q(t,x),name:l,form:A,capture:b,...z})]})});L.displayName="@mantine/core/FileButton";/**
 * @license @tabler/icons-react v3.11.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var pe=ae("outline","refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]]);function ue({documentId:s}){const[t,o]=C.useState("reviewal"),{closeModal:n,modals:a}=M(),c=W(t,a.createDocumentApproval),{data:l,setData:A,post:p,processing:R,errors:b,reset:z}=E({document_id:"",resolution:"",destination:"",type:"reviewal",users:[]}),[d,x]=C.useState([]),u=c.length;C.useEffect(()=>{x([])},[t,c]);const U=j=>{j.preventDefault();const y=d.map(i=>parseInt(i.selectedUser)).filter(i=>!isNaN(i));l.document_id=s??"",l.users=y.map(i=>({user_id:i.toString()})),p(route("document_approvals.store"),{preserveScroll:!0,onSuccess:()=>{n("createDocumentApproval"),w.show({message:"Document approval process created",color:"green"})},onError:()=>{w.show({message:"Something went wrong",color:"red"})},onFinish:()=>z()})},m=()=>{d.length<u&&x([...d,{selectedUser:""}])},f=()=>{const j=d.map(r=>r.selectedUser),i=c.filter(r=>!j.includes(r.id.toString())).map(r=>({selectedUser:r.id.toString()}));x([...d,...i])},D=j=>{const y=[...d];y.splice(j,1),x(y)},g=(j,y)=>{const i=[...d];i[j].selectedUser=y||"",x(i)},I=d.map(j=>j.selectedUser).filter(j=>j!=="");return{data:l,setData:A,createApprovalSubmit:U,processing:R,errors:b,users:d,setDocumentApprovalType:o,addUser:m,removeUser:D,handleUserChange:g,addAllUsers:f,maxUsers:u,selectedUserIds:I,fetchedUsers:c}}const me=({document:s})=>{const{data:t,setData:o,createApprovalSubmit:n,processing:a,errors:c,users:l,setDocumentApprovalType:A,addUser:p,removeUser:R,handleUserChange:b,addAllUsers:z,maxUsers:d,selectedUserIds:x,fetchedUsers:u}=ue({documentId:s==null?void 0:s.item_id}),{modals:U,closeModal:m}=M(),f=D=>u.filter(g=>!x.includes(g.id.toString())||g.id.toString()===l[D].selectedUser).map(g=>({value:g.id.toString(),label:`${g.name} (${g.email})`}));return e.jsx(G,{opened:U.createDocumentApproval,onClose:()=>m("createDocumentApproval"),title:e.jsx(v,{fw:"bold",size:"lg",children:"Create Document Approval Process"}),size:550,children:e.jsxs("form",{onSubmit:n,children:[e.jsxs(N,{gap:16,children:[e.jsx(v,{size:"sm",color:"dimmed",children:"Routinely directs any uploaded file in this folder through a predefined document approval process"}),e.jsx(V.Group,{name:"status",value:t.type,onChange:D=>{o("type",D),A(D)},children:e.jsxs(_,{mt:"xs",children:[e.jsx(V,{value:"reviewal",label:"Review"}),e.jsx(V,{value:"approval",label:"Approval"})]})}),e.jsx(q,{label:"Resolution",placeholder:"Your resolution for this approval",value:t.resolution??"",onChange:D=>o("resolution",D.target.value),error:c.resolution,autosize:!0,minRows:2,maxRows:4}),e.jsx(v,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),l.map((D,g)=>e.jsxs(_,{justify:"space-between",align:"flex-end",children:[e.jsx(H,{placeholder:"Select a user",data:f(g),value:D.selectedUser,onChange:I=>b(g,I),required:!0,style:{flex:1},allowDeselect:!1}),e.jsx(T,{color:"red",onClick:()=>R(g),title:"Remove User",children:e.jsx(P,{size:18})})]},g)),e.jsxs(_,{children:[l.length<d&&e.jsx(S,{variant:"subtle",color:"green",leftSection:e.jsx(B,{size:16}),onClick:p,disabled:l.length>=d,children:"Add User"}),x.length<d&&e.jsx(S,{variant:"subtle",color:"blue",leftSection:e.jsx(B,{size:16}),onClick:z,disabled:l.length>=d,children:"Add All Users"})]})]}),e.jsxs($,{align:"center",justify:"end",mt:16,children:[e.jsx(S,{variant:"light",onClick:()=>m("createDocumentApproval"),children:"Cancel"}),e.jsx(S,{ml:12,type:"submit",loading:a,children:"Create"})]})]})})};function he({documentApprovalId:s,isOpen:t}){const[o,n]=C.useState(null);C.useEffect(()=>{s&&t&&a(s)},[s,t]);const a=async c=>{try{const l=await X.get(`/document_approval/${c}/update`);n(l.data)}catch(l){console.error("Error fetching document approval",l)}};return o}function ve({documentApprovalId:s,isOpen:t}){const[o,n]=C.useState("reviewal"),a=he({documentApprovalId:s,isOpen:t}),c=W(o,t),{closeModal:l}=M(),{data:A,setData:p,put:R,processing:b,errors:z,reset:d,clearErrors:x}=E({resolution:"",type:"",users:[]}),[u,U]=C.useState([]),m=c.length;C.useEffect(()=>{a&&(n(a.type||""),p({resolution:a.resolution||"",type:a.type||"",users:(a.document_user_approvals||[]).map(r=>({user_id:r.user_id}))}),U((a.document_user_approvals||[]).map(r=>({selectedUser:r.user_id.toString()}))))},[a,t]),C.useEffect(()=>{U([])},[o]);const f=()=>{l("viewDocumentApproval"),d(),x()},D=r=>{r.preventDefault(),A.users=u.map(h=>parseInt(h.selectedUser)).filter(h=>!isNaN(h)).map(h=>({user_id:h.toString()})),R(route("document_approvals.update",s),{onSuccess:()=>{f(),w.show({message:"Document approval updated successfully",color:"green"})},onError:()=>{w.show({message:"Something went wrong",color:"red"})},onFinish:()=>d()})},g=()=>{u.length<m&&U([...u,{selectedUser:""}])},I=()=>{const r=u.map(F=>F.selectedUser),k=c.filter(F=>!r.includes(F.id.toString())).map(F=>({selectedUser:F.id.toString()}));U([...u,...k])},j=r=>{const h=[...u];h.splice(r,1),U(h)},y=(r,h)=>{const k=[...u];k[r].selectedUser=h||"",U(k)},i=u.map(r=>r.selectedUser).filter(r=>r!=="");return{data:A,setData:p,handleUpdateDocumentApproval:D,processing:b,errors:z,handleClose:f,users:u,documentApproval:a,setDocumentApprovalType:n,addUser:g,removeUser:j,handleUserChange:y,addAllUsers:I,maxUsers:m,selectedUserIds:i,fetchedUsers:c}}function fe({documentApprovalId:s,onDeleteSuccess:t}){const{delete:o,processing:n}=E();return{handleDeleteDocumentApproval:()=>{if(!s){w.show({message:"Document Approval ID is missing.",color:"red"});return}o(route("document_approvals.cancel",s),{onSuccess:()=>{w.show({message:"Document Approval deleted successfully.",color:"green"}),t()},onError:c=>{let l="Failed to delete document approval.";c&&Object.keys(c).length>0&&(l=c[Object.keys(c)[0]]),w.show({message:l,color:"red"})}})},processing:n}}const ge=({documentApprovalId:s})=>{const{modals:t,closeModal:o,openModal:n}=M(),a=t.confirmDeleteDocumentApproval,{handleDeleteDocumentApproval:c,processing:l}=fe({documentApprovalId:s,onDeleteSuccess:()=>{o("confirmDeleteDocumentApproval"),o("viewDocumentApproval")}});return e.jsxs(G,{opened:a,onClose:()=>o("confirmDeleteDocumentApproval"),title:e.jsx(v,{fw:"bold",size:"lg",children:"Confirm Delete"}),size:"sm",centered:!0,children:[e.jsx(v,{c:"gray.8",children:"Are you sure you want to cancel this document approval? This action cannot be undone."}),e.jsxs($,{align:"center",justify:"flex-end",mt:16,children:[e.jsx(S,{variant:"light",onClick:()=>{o("confirmDeleteDocumentApproval"),n("viewDocumentApproval")},children:"Cancel"}),e.jsx(S,{color:"red",ml:12,onClick:c,loading:l,children:"Delete"})]})]})},xe=({document:s})=>{const{modals:t,closeModal:o,openModal:n}=M(),a=t.viewDocumentApproval,{data:c,setData:l,handleUpdateDocumentApproval:A,processing:p,errors:R,users:b,setDocumentApprovalType:z,addUser:d,removeUser:x,handleUserChange:u,addAllUsers:U,documentApproval:m,maxUsers:f,selectedUserIds:D,fetchedUsers:g}=ve({documentApprovalId:s==null?void 0:s.document_approval_id,isOpen:a}),I=i=>g.filter(r=>!D.includes(r.id.toString())||r.id.toString()===b[i].selectedUser).map(r=>({value:r.id.toString(),label:`${r.name} (${r.email})`})),j=m==null?void 0:m.document_user_approvals.some(i=>["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(i.user_state)),y=m==null?void 0:m.document_user_approvals.every(i=>["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(i.user_state));return e.jsxs(e.Fragment,{children:[e.jsx(G,{opened:a,onClose:()=>o("viewDocumentApproval"),title:e.jsx(v,{fw:"bold",size:"lg",children:"Document Workflow Process"}),size:550,children:e.jsxs("form",{onSubmit:A,children:[e.jsxs(N,{gap:16,children:[e.jsx(v,{size:"sm",children:"View the document workflow process for this document"}),!j&&e.jsx(V.Group,{name:"status",value:c.type,onChange:i=>{l("type",i),z(i)},children:e.jsxs(_,{mt:"xs",children:[e.jsx(V,{value:"reviewal",label:"Review"}),e.jsx(V,{value:"approval",label:"Approval"})]})}),e.jsx(q,{label:"Resolution",placeholder:"Your resolution for this approval",value:c.resolution??"",onChange:i=>l("resolution",i.target.value),error:R.resolution,autosize:!0,minRows:2,maxRows:4,readOnly:j}),e.jsx(v,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),b.map((i,r)=>{const h=m==null?void 0:m.document_user_approvals.find(F=>F.user_id.toString()===i.selectedUser);console.log("userApproval",h);const k=h&&["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(h.user_state);return e.jsxs(_,{justify:"space-between",align:"flex-end",children:[e.jsxs(_,{children:[e.jsx(le,{approvalStatus:h==null?void 0:h.user_state})," "]}),e.jsx(H,{placeholder:"Select a user",data:I(r),value:i.selectedUser,onChange:F=>u(r,F),required:!k,style:{flex:1},allowDeselect:!k,readOnly:k}),!k&&e.jsx(T,{color:"red",onClick:()=>x(r),title:"Remove User",children:e.jsx(P,{size:18})})]},r)}),!y&&e.jsxs(_,{children:[b.length<f&&e.jsx(S,{variant:"subtle",color:"green",leftSection:e.jsx(B,{size:16}),onClick:d,disabled:b.length>=f,children:"Add User"}),D.length<f&&e.jsx(S,{variant:"subtle",color:"blue",leftSection:e.jsx(B,{size:16}),onClick:U,disabled:b.length>=f,children:"Add All Users"})]})]}),e.jsxs($,{align:"center",justify:"end",mt:16,children:[e.jsx(S,{variant:"light",onClick:()=>o("viewDocumentApproval"),children:y?"Close":"Cancel"}),!y&&e.jsxs(e.Fragment,{children:[e.jsx(S,{ml:12,type:"submit",loading:p,children:"Update"}),e.jsx(T,{variant:"transparent",color:"red",onClick:()=>{o("viewDocumentApproval"),n("confirmDeleteDocumentApproval")},title:"Delete Document Approval",ml:12,children:e.jsx(P,{size:18})})]})]})]})}),e.jsx(ge,{documentApprovalId:s==null?void 0:s.document_approval_id})]})};function je(){const{post:s,processing:t}=E();return{restoreVersion:n=>{s(route("document.restore_version",{version:n}),{onSuccess:()=>{w.show({message:"Document version restored successfully.",color:"green"})},onError:()=>{w.show({message:"Failed to restore document version.",color:"red"})}})},processing:t}}function De(){const{delete:s,processing:t}=E();return{deleteVersion:n=>{s(route("document.delete_version",{version:n}),{onSuccess:()=>{w.show({message:"Document version deleted successfully.",color:"green"})},onError:()=>{w.show({message:"Failed to delete document version.",color:"red"})}})},processing:t}}const Ue=({versions:s})=>{const{restoreVersion:t}=je(),{deleteVersion:o}=De();return e.jsx(Y,{columns:[{accessor:"name",title:"Name"},{accessor:"uploaded_at",title:"Uploaded At"},{accessor:"actions",title:"Actions",render:n=>e.jsxs(_,{gap:4,children:[e.jsx(T,{variant:"subtle",onClick:()=>t(n.id),children:e.jsx(pe,{size:16})}),e.jsx(T,{variant:"subtle",color:"red",onClick:()=>o(n.id),children:e.jsx(P,{size:16})}),e.jsx("a",{href:n.file_path,download:!0,children:e.jsx(T,{variant:"subtle",children:e.jsx(ce,{size:16})})})]})}],records:s,highlightOnHover:!0,verticalSpacing:"sm",horizontalSpacing:"sm"})};function we(s){const{data:t,post:o,reset:n,processing:a,errors:c,clearErrors:l}=E({document_item_id:s,file:null});return{uploadVersion:p=>{if(!p){w.show({message:"No file selected.",color:"red"});return}t.file=p,o(`/document/${s}/versions`,{onSuccess:()=>{w.show({message:"Document version uploaded successfully.",color:"green"}),n()},onError:()=>{w.show({message:"Failed to upload document version.",color:"red"})},onFinish:()=>{l()}})},processing:a,errors:c}}const Le=({document:s,itemAncestors:t,activityLog:o})=>{const{openModal:n}=M(),{uploadVersion:a,processing:c,errors:l}=we(s.item_id),A=p=>{p&&a(p)};return e.jsxs(re,{children:[e.jsx(Z,{title:"Document Properties"}),e.jsx(ee,{px:8,py:8,mb:48,children:e.jsx(oe,{ancestors:t})}),e.jsxs(O,{children:[e.jsx(O.Col,{span:8,children:e.jsxs(N,{px:8,py:8,gap:48,mb:48,children:[e.jsxs(_,{children:[e.jsx(ie,{size:56,stroke:1,color:"gray"}),e.jsx(v,{fw:500,children:s.name})]}),e.jsxs(_,{justify:"space-between",w:700,children:[e.jsxs("div",{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Document ID"}),e.jsx(v,{size:"sm",children:s.item_id})]}),e.jsxs("div",{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Date"}),e.jsx(v,{size:"sm",children:s.created_at})]}),e.jsxs("div",{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Document Number"}),e.jsx(v,{size:"sm",children:s.document_number})]})]}),e.jsxs(N,{gap:12,children:[s.versions.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Document Versions"}),e.jsx(Ue,{versions:s.versions})]}),e.jsx(v,{size:"sm",fw:"bold",children:"Audit Log"}),e.jsx(Y,{textSelectionDisabled:!0,columns:[{accessor:"date"},{accessor:"time"},{accessor:"user_name",title:"User"},{accessor:"description",title:"Action"}],records:o,highlightOnHover:!0,verticalSpacing:"lg",horizontalSpacing:"xl",withTableBorder:!0})]})]})}),e.jsx(O.Col,{span:3,offset:1,children:e.jsxs(se,{withBorder:!0,p:20,children:[e.jsx(v,{c:"dimmed",fw:500,children:"Options"}),e.jsx(L,{onChange:A,children:p=>e.jsx(S,{...p,variant:"subtle",color:"blue.5",fullWidth:!0,justify:"left",leftSection:e.jsx(te,{size:18}),children:"Upload New Version"})}),e.jsxs(S,{variant:"subtle",color:"blue.5",leftSection:e.jsx(ne,{size:18}),fullWidth:!0,justify:"left",onClick:()=>{n(s.document_approval_id?"viewDocumentApproval":"createDocumentApproval")},children:[s.document_approval_id?"View":"Start"," Approval Process"]})]})})]}),e.jsx(me,{document:s}),e.jsx(xe,{document:s})]})};export{Le as default};
