import{b,j as e,M as A,W as R,n as w,Y as z,y as E}from"./app-2En39ju7.js";import{u as S,a as k,b as y,A as T}from"./Authenticated-qBikI9Bj.js";import{u as O}from"./use-fetch-metadata-C9YDaLQl.js";import{u as P,C as M}from"./Combobox-DGCT7W1T.js";import{S as h}from"./Stack-BIYYsV2c.js";import{I as U}from"./InputBase-CEeec65K.js";import{G as D,A as I,c as B}from"./NotificationMenu-BSTeGUj5.js";import{B as v}from"./Button-DF2Simw3.js";import{T as C}from"./TextInput-DhwSJPcY.js";import{T as _,F as L}from"./OfficeLogo-TV6DJJog.js";import{A as q,I as G,u as N,a as Y}from"./use-show-items-for-moving-DVGSpCB8.js";import{I as H}from"./IconFolder-DAch7xLN.js";import{I as V}from"./IconFile-CvpEkb90.js";import{I as W}from"./IconEdit-B7c9uoKz.js";import{T as $}from"./Textarea-y3G6kJsx.js";import{D as J}from"./DatePickerInput-DBGX-74A.js";import"./Popover-BcrPVCG-.js";import"./use-uncontrolled-xJtqzgc0.js";import"./IconUser-BN6Z6Xy6.js";import"./get-sorted-breakpoints-Dr8R6tSd.js";import"./clamp-DTmYCdls.js";const K=({onAdd:a})=>{const{modals:m,closeModal:n}=S(),l=m.addDocumentMetadata,{metadataList:c}=O(),[s,r]=b.useState(null),u=P({onDropdownClose:()=>u.resetSelectedOption()}),p=()=>{s&&(a(s),n("addDocumentMetadata"),r(null))},g=c.map(d=>e.jsx(M.Option,{value:d.metadata_id.toString(),children:d.name},d.metadata_id));return e.jsx(A,{opened:l,onClose:()=>n("addDocumentMetadata"),title:"Add Custom Metadata",children:e.jsxs(h,{gap:16,children:[e.jsxs(M,{store:u,onOptionSubmit:d=>{const x=c.find(t=>t.metadata_id.toString()===d)||null;r(x),u.closeDropdown()},children:[e.jsx(M.Target,{children:e.jsx(U,{component:"button",type:"button",rightSection:e.jsx(M.Chevron,{}),onClick:()=>u.toggleDropdown(),children:s?s.name:"Select Metadata"})}),e.jsx(M.Dropdown,{children:e.jsx(M.Options,{children:g})})]}),e.jsxs(D,{justify:"flex-end",children:[e.jsx(v,{variant:"outline",onClick:()=>n("addDocumentMetadata"),children:"Cancel"}),e.jsx(v,{onClick:p,disabled:!s,children:"Add"})]})]})})},Q=({metadata:a,requiredMetadata:m,onAdd:n,onUpdate:l,onChange:c,onDelete:s})=>{const{openModal:r}=S(),u=t=>{n&&n(t)},p=()=>{r("addDocumentMetadata")},g=t=>{const i=a[t],j=a.filter((o,f)=>f!==t);l&&l(j),s&&i.metadata_id!==0&&s(i.metadata_id)},d=(t,i,j)=>{const o=a.map((f,F)=>F===t?{...f,[i]:j}:f);c&&c(o)},x=b.useMemo(()=>{const t=a.map(i=>i.metadata_id);return m.filter(i=>!t.includes(i.metadata_id))},[a,m]);return e.jsxs(h,{children:[a.map((t,i)=>e.jsxs(D,{grow:!0,align:"flex-end",children:[e.jsx(C,{disabled:!0,label:"Name",placeholder:"Metadata name",value:t.name,onChange:j=>d(i,"name",j.target.value)}),e.jsx(C,{label:"Value",placeholder:"Metadata value",value:t.value,onChange:j=>d(i,"value",j.target.value)}),e.jsx(I,{color:"red",onClick:()=>g(i),children:e.jsx(k,{size:16})})]},t.metadata_id||i)),x.length>0&&e.jsxs(h,{gap:"xs",children:[e.jsx(_,{c:"red",size:"sm",children:"Missing Required Metadata:"}),x.map(t=>e.jsx(q,{icon:e.jsx(G,{size:16}),title:`${t.name} is missing`,color:"red",variant:"light"},t.metadata_id))]}),e.jsx(v,{variant:"light",onClick:p,leftSection:e.jsx(y,{size:14}),children:"Add Custom Metadata"}),e.jsx(K,{onAdd:t=>u({metadata_id:t.metadata_id,name:t.name,value:""})})]})},X=({onAdd:a})=>{const{modals:m,closeModal:n}=S(),l=m.relatedDocumentModal,[c,s]=b.useState(null),{data:r,loading:u,error:p}=N(c,l),g=t=>{s(t)},d=()=>{r.itemParent&&r.itemParent.parent_id?s(r.itemParent.parent_id):s(null)},x=t=>{a(t),n("relatedDocumentModal"),s(null)};return e.jsx(A,{opened:l,onClose:()=>n("relatedDocumentModal"),title:"Select Related Document",size:"lg",children:e.jsxs(h,{gap:"md",children:[e.jsxs(D,{children:[c&&e.jsx(I,{onClick:d,children:e.jsx(Y,{size:16})}),e.jsx(_,{children:"Select a document to relate"})]}),u?e.jsx(_,{children:"Loading..."}):p?e.jsx(_,{c:"red",children:p}):e.jsx(h,{style:{maxHeight:400,overflowY:"auto"},children:r.itemContents.map(t=>e.jsxs(D,{style:{cursor:"pointer"},onClick:()=>{t.type==="folder"?g(t.item_id):x({item_id:t.item_id,name:t.name})},children:[t.type==="folder"?e.jsx(H,{}):e.jsx(V,{}),e.jsx(_,{children:t.name})]},t.item_id))})]})})},Z=({relatedDocuments:a,onChange:m})=>{const{openModal:n}=S(),l=s=>{const r=[...a,s];m&&m(r)},c=s=>{const r=a.filter((u,p)=>p!==s);m&&m(r)};return e.jsxs(h,{children:[a.map((s,r)=>e.jsxs(D,{grow:!0,align:"center",children:[e.jsx(_,{children:s.name}),e.jsx(I,{color:"red",onClick:()=>c(r),children:e.jsx(k,{size:16})})]},s.item_id)),e.jsx(X,{onAdd:l}),e.jsx(v,{variant:"light",onClick:()=>n("relatedDocumentModal"),leftSection:e.jsx(y,{size:14}),children:"Add Related Document"})]})};function ee({document:a,onSuccess:m}){const{data:n,setData:l,put:c,processing:s,errors:r,reset:u,clearErrors:p}=R({name:a.name,document_number:a.document_number||"",description:a.description||"",due_date:a.due_date||"",update_metadata:a.metadata.map(d=>({metadata_id:d.metadata_id,name:d.name,value:d.value})),delete_metadata:[],related_documents:a.related_documents.map(d=>({item_id:d.item_id,name:d.name}))});return{data:n,setData:l,handleUpdateDocument:d=>{d.preventDefault(),c(route("document.save",a.item_id),{onSuccess:()=>{w.show({message:"Document updated successfully",color:"green"})},onError:x=>{w.show({message:"Failed to update document",color:"red"})},onFinish:()=>p()})},processing:s,errors:r,reset:u}}function ve({document:a,itemAncestors:m}){const{data:n,setData:l,handleUpdateDocument:c,processing:s,errors:r,reset:u}=ee({document:a}),[p,g]=b.useState([]),d=o=>{l("update_metadata",[...n.update_metadata||[],o])},x=o=>{n.update_metadata=o},t=o=>{l("update_metadata",o)},i=o=>{g(f=>[...f,o]),l("delete_metadata",[...n.delete_metadata||[],{metadata_id:o}])},j=o=>{l("related_documents",o)};return e.jsxs(T,{children:[e.jsx(z,{title:"Document Properties"}),e.jsxs(h,{px:8,py:8,gap:24,w:550,mb:72,children:[e.jsxs(D,{mt:24,align:"center",children:[e.jsx(B,{mime:a.mime,isFolder:!1,approvalStatus:a.status}),e.jsx(_,{fw:500,children:n.name}),e.jsx(I,{variant:"subtle",color:"gray",children:e.jsx(W,{size:24})})]}),e.jsxs("form",{onSubmit:c,children:[e.jsxs(h,{gap:12,children:[e.jsx(C,{label:"Document Number",name:"document_number",value:n.document_number,onChange:o=>l("document_number",o.target.value),placeholder:"Enter document number"}),e.jsx(C,{type:"text",label:"Created At",value:a.created_at,disabled:!0}),e.jsx($,{label:"Description",autosize:!0,minRows:4,maxRows:6,placeholder:"Enter description",value:n.description,onChange:o=>l("description",o.target.value)}),e.jsx(J,{label:"Due Date",placeholder:"Select due date",value:n.due_date?new Date(n.due_date):void 0,onChange:o=>l("due_date",(o==null?void 0:o.toISOString())??void 0)})]}),e.jsxs(h,{gap:12,mt:16,children:[e.jsx(_,{size:"sm",fw:500,children:"Custom Metadata Field"}),e.jsx(Q,{metadata:n.update_metadata??[],requiredMetadata:a.required_folder_metadata,onAdd:d,onUpdate:x,onChange:t,onDelete:i})]}),e.jsxs(h,{gap:12,mt:16,children:[e.jsx(_,{size:"sm",fw:500,children:"Related Documents"}),e.jsx(Z,{relatedDocuments:n.related_documents||[],onChange:j})]}),e.jsxs(L,{align:"center",justify:"end",mt:16,children:[e.jsx(v,{variant:"light",onClick:()=>E.visit(route("document.show",{document:a.item_id})),children:"Cancel"}),e.jsx(v,{ml:12,type:"submit",loading:s,children:"Save Changes"})]})]})]})]})}export{ve as default};
