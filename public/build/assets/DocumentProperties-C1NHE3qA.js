import{b as z,u as J,h as K,j as e,i as Q,W as T,n as D,M as O,c as X,Y as Z,B as ee,P as se}from"./app-DHbb7XZB.js";import{u as V,a as P,b as B,A as re}from"./Authenticated-DWZpg9um.js";import{Y}from"./index-D_XodZT9.js";import{I as oe}from"./ItemBreadcrumbs-B8WEsHim.js";import{u as q,R as F,I as te,a as ne}from"./use-fetch-users-approval-role-D0MjYxgc.js";import{T as m,F as $}from"./OfficeLogo-C6ryGmry.js";import{S as N}from"./Stack-BnRli6BO.js";import{G as k,A as I}from"./NotificationMenu-DLxJWaSh.js";import{T as W}from"./Textarea-DoT4cs20.js";import{S as H}from"./Select-De12jFwc.js";import{B as y}from"./Button-De38AkdO.js";import{c as le}from"./IconUser-CvGZT8Us.js";import{I as ae}from"./IconDownload-CNXXB5sP.js";import{G}from"./Grid-DVt61pfj.js";import{I as ce}from"./IconFile-Ca6f2_vG.js";import"./TextInput-B2cdI1__.js";import"./InputBase-C-93sqIY.js";import"./Popover-DHSW6Xue.js";import"./use-uncontrolled-B1gi51Y9.js";import"./get-sorted-breakpoints-BYD2hfL9.js";import"./Checkbox-DhvQdy4I.js";import"./CheckIcon-fVhk7RRX.js";import"./ScrollArea-C3btK3uF.js";import"./Anchor-CgujKe5m.js";import"./Combobox-Dmw127jY.js";import"./get-base-value-JqT_q0U7.js";const ie={multiple:!1},L=z.forwardRef((s,o)=>{const{onChange:r,children:t,multiple:a,accept:l,name:n,form:U,resetRef:p,disabled:_,capture:A,inputProps:R,...i}=J("FileButton",ie,s),v=z.useRef(),u=()=>{var f;!_&&((f=v.current)==null||f.click())},g=f=>{r(a?Array.from(f.currentTarget.files):f.currentTarget.files[0]||null)};return K(p,()=>{v.current.value=""}),e.jsxs(e.Fragment,{children:[t({onClick:u,...i}),e.jsx("input",{style:{display:"none"},type:"file",accept:l,multiple:a,onChange:g,ref:Q(o,v),name:n,form:U,capture:A,...R})]})});L.displayName="@mantine/core/FileButton";/**
 * @license @tabler/icons-react v3.11.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var de=le("outline","refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]]);function pe({documentId:s}){const[o,r]=z.useState("reviewal"),{closeModal:t,modals:a}=V(),l=q(o,a.createDocumentApproval),{data:n,setData:U,post:p,processing:_,errors:A,reset:R}=T({document_id:"",resolution:"",destination:"",type:"reviewal",users:[]}),[i,v]=z.useState([]),u=l.length;z.useEffect(()=>{v([])},[o,l]);const g=c=>{c.preventDefault();const S=i.map(w=>parseInt(w.selectedUser)).filter(w=>!isNaN(w));n.document_id=s??"",n.users=S.map(w=>({user_id:w.toString()})),p(route("document_approvals.store"),{preserveScroll:!0,onSuccess:()=>{t("createDocumentApproval"),D.show({message:"Document approval process created",color:"green"})},onError:()=>{D.show({message:"Something went wrong",color:"red"})},onFinish:()=>R()})},b=()=>{i.length<u&&v([...i,{selectedUser:""}])},f=()=>{const c=i.map(d=>d.selectedUser),w=l.filter(d=>!c.includes(d.id.toString())).map(d=>({selectedUser:d.id.toString()}));v([...i,...w])},x=c=>{const S=[...i];S.splice(c,1),v(S)},h=(c,S)=>{const w=[...i];w[c].selectedUser=S||"",v(w)},j=i.map(c=>c.selectedUser).filter(c=>c!=="");return{data:n,setData:U,createApprovalSubmit:g,processing:_,errors:A,users:i,setDocumentApprovalType:r,addUser:b,removeUser:x,handleUserChange:h,addAllUsers:f,maxUsers:u,selectedUserIds:j,fetchedUsers:l}}const ue=({document:s})=>{const{data:o,setData:r,createApprovalSubmit:t,processing:a,errors:l,users:n,setDocumentApprovalType:U,addUser:p,removeUser:_,handleUserChange:A,addAllUsers:R,maxUsers:i,selectedUserIds:v,fetchedUsers:u}=pe({documentId:s==null?void 0:s.item_id}),{modals:g,closeModal:b}=V(),f=x=>u.filter(h=>!v.includes(h.id.toString())||h.id.toString()===n[x].selectedUser).map(h=>({value:h.id.toString(),label:`${h.name} (${h.email})`}));return e.jsx(O,{opened:g.createDocumentApproval,onClose:()=>b("createDocumentApproval"),title:e.jsx(m,{fw:"bold",size:"lg",children:"Create Document Approval Process"}),size:550,children:e.jsxs("form",{onSubmit:t,children:[e.jsxs(N,{gap:16,children:[e.jsx(m,{size:"sm",color:"dimmed",children:"Routinely directs any uploaded file in this folder through a predefined document approval process"}),e.jsx(F.Group,{name:"status",value:o.type,onChange:x=>{r("type",x),U(x)},children:e.jsxs(k,{mt:"xs",children:[e.jsx(F,{value:"reviewal",label:"Review"}),e.jsx(F,{value:"approval",label:"Approval"})]})}),e.jsx(W,{label:"Resolution",placeholder:"Your resolution for this approval",value:o.resolution??"",onChange:x=>r("resolution",x.target.value),error:l.resolution,autosize:!0,minRows:2,maxRows:4}),e.jsx(m,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),n.map((x,h)=>e.jsxs(k,{justify:"space-between",align:"flex-end",children:[e.jsx(H,{placeholder:"Select a user",data:f(h),value:x.selectedUser,onChange:j=>A(h,j),required:!0,style:{flex:1},allowDeselect:!1}),e.jsx(I,{color:"red",onClick:()=>_(h),title:"Remove User",children:e.jsx(P,{size:18})})]},h)),e.jsxs(k,{children:[n.length<i&&e.jsx(y,{variant:"subtle",color:"green",leftSection:e.jsx(B,{size:16}),onClick:p,disabled:n.length>=i,children:"Add User"}),v.length<i&&e.jsx(y,{variant:"subtle",color:"blue",leftSection:e.jsx(B,{size:16}),onClick:R,disabled:n.length>=i,children:"Add All Users"})]})]}),e.jsxs($,{align:"center",justify:"end",mt:16,children:[e.jsx(y,{variant:"light",onClick:()=>b("createDocumentApproval"),children:"Cancel"}),e.jsx(y,{ml:12,type:"submit",loading:a,children:"Create"})]})]})})};function me({documentApprovalId:s,isOpen:o}){const[r,t]=z.useState(null);z.useEffect(()=>{s&&o&&a(s)},[s,o]);const a=async l=>{try{const n=await X.get(`/document_approval/${l}/update`);t(n.data)}catch(n){console.error("Error fetching document approval",n)}};return r}function he({documentApprovalId:s,isOpen:o}){const[r,t]=z.useState("reviewal"),a=me({documentApprovalId:s,isOpen:o}),l=q(r,o),{closeModal:n}=V(),{data:U,setData:p,put:_,processing:A,errors:R,reset:i,clearErrors:v}=T({resolution:"",type:"",users:[]}),[u,g]=z.useState([]),b=l.length;z.useEffect(()=>{a&&(t(a.type||""),p({resolution:a.resolution||"",type:a.type||"",users:(a.document_user_approvals||[]).map(d=>({user_id:d.user_id}))}),g((a.document_user_approvals||[]).map(d=>({selectedUser:d.user_id.toString()}))))},[a,o]),z.useEffect(()=>{g([])},[r]);const f=()=>{n("updateDocumentApproval"),i(),v()},x=d=>{d.preventDefault(),U.users=u.map(C=>parseInt(C.selectedUser)).filter(C=>!isNaN(C)).map(C=>({user_id:C.toString()})),_(route("document_approvals.update",s),{onSuccess:()=>{f(),D.show({message:"Document approval updated successfully",color:"green"})},onError:()=>{D.show({message:"Something went wrong",color:"red"})},onFinish:()=>i()})},h=()=>{u.length<b&&g([...u,{selectedUser:""}])},j=()=>{const d=u.map(E=>E.selectedUser),M=l.filter(E=>!d.includes(E.id.toString())).map(E=>({selectedUser:E.id.toString()}));g([...u,...M])},c=d=>{const C=[...u];C.splice(d,1),g(C)},S=(d,C)=>{const M=[...u];M[d].selectedUser=C||"",g(M)},w=u.map(d=>d.selectedUser).filter(d=>d!=="");return{data:U,setData:p,handleUpdateDocumentApproval:x,processing:A,errors:R,handleClose:f,users:u,setDocumentApprovalType:t,addUser:h,removeUser:c,handleUserChange:S,addAllUsers:j,maxUsers:b,selectedUserIds:w,fetchedUsers:l}}function ve({documentApprovalId:s,onDeleteSuccess:o}){const{delete:r,processing:t}=T();return{handleDeleteDocumentApproval:()=>{if(!s){D.show({message:"Document Approval ID is missing.",color:"red"});return}r(route("document_approvals.cancel",s),{onSuccess:()=>{D.show({message:"Document Approval deleted successfully.",color:"green"}),o()},onError:l=>{let n="Failed to delete document approval.";l&&Object.keys(l).length>0&&(n=l[Object.keys(l)[0]]),D.show({message:n,color:"red"})}})},processing:t}}const fe=({documentApprovalId:s})=>{const{modals:o,closeModal:r,openModal:t}=V(),a=o.confirmDeleteDocumentApproval,{handleDeleteDocumentApproval:l,processing:n}=ve({documentApprovalId:s,onDeleteSuccess:()=>{r("confirmDeleteDocumentApproval"),r("updateDocumentApproval")}});return e.jsxs(O,{opened:a,onClose:()=>r("confirmDeleteDocumentApproval"),title:e.jsx(m,{fw:"bold",size:"lg",children:"Confirm Delete"}),size:"sm",centered:!0,children:[e.jsx(m,{c:"gray.8",children:"Are you sure you want to cancel this document approval? This action cannot be undone."}),e.jsxs($,{align:"center",justify:"flex-end",mt:16,children:[e.jsx(y,{variant:"light",onClick:()=>{r("confirmDeleteDocumentApproval"),t("updateDocumentApproval")},children:"Cancel"}),e.jsx(y,{color:"red",ml:12,onClick:l,loading:n,children:"Delete"})]})]})},ge=({document:s})=>{const{modals:o,closeModal:r,openModal:t}=V(),a=o.updateDocumentApproval,{data:l,setData:n,handleUpdateDocumentApproval:U,processing:p,errors:_,users:A,setDocumentApprovalType:R,addUser:i,removeUser:v,handleUserChange:u,addAllUsers:g,maxUsers:b,selectedUserIds:f,fetchedUsers:x}=he({documentApprovalId:s==null?void 0:s.document_approval_id,isOpen:a}),h=j=>x.filter(c=>!f.includes(c.id.toString())||c.id.toString()===A[j].selectedUser).map(c=>({value:c.id.toString(),label:`${c.name} (${c.email})`}));return e.jsxs(e.Fragment,{children:[e.jsx(O,{opened:a,onClose:()=>r("updateDocumentApproval"),title:e.jsx(m,{fw:"bold",size:"lg",children:"Update Document Approval Process"}),size:550,children:e.jsxs("form",{onSubmit:U,children:[e.jsxs(N,{gap:16,children:[e.jsx(m,{size:"sm",color:"dimmed",children:"Routinely directs any uploaded file in this folder through a predefined document approval process"}),e.jsx(F.Group,{name:"status",value:l.type,onChange:j=>{n("type",j),R(j)},children:e.jsxs(k,{mt:"xs",children:[e.jsx(F,{value:"reviewal",label:"Review"}),e.jsx(F,{value:"approval",label:"Approval"})]})}),e.jsx(W,{label:"Resolution",placeholder:"Your resolution for this approval",value:l.resolution??"",onChange:j=>n("resolution",j.target.value),error:_.resolution,autosize:!0,minRows:2,maxRows:4}),e.jsx(m,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),A.map((j,c)=>e.jsxs(k,{justify:"space-between",align:"flex-end",children:[e.jsx(H,{placeholder:"Select a user",data:h(c),value:j.selectedUser,onChange:S=>u(c,S),required:!0,style:{flex:1},allowDeselect:!1}),e.jsx(I,{color:"red",onClick:()=>v(c),title:"Remove User",children:e.jsx(P,{size:18})})]},c)),e.jsxs(k,{children:[A.length<b&&e.jsx(y,{variant:"subtle",color:"green",leftSection:e.jsx(B,{size:16}),onClick:i,disabled:A.length>=b,children:"Add User"}),f.length<b&&e.jsx(y,{variant:"subtle",color:"blue",leftSection:e.jsx(B,{size:16}),onClick:g,disabled:A.length>=b,children:"Add All Users"})]})]}),e.jsxs($,{align:"center",justify:"end",mt:16,children:[e.jsx(y,{variant:"light",onClick:()=>r("updateDocumentApproval"),children:"Cancel"}),e.jsx(y,{ml:12,type:"submit",loading:p,children:"Update"}),e.jsx(I,{variant:"transparent",color:"red",onClick:()=>{r("updateDocumentApproval"),t("confirmDeleteDocumentApproval")},title:"Delete Document Approval",ml:12,children:e.jsx(P,{size:18})})]})]})}),e.jsx(fe,{documentApprovalId:s==null?void 0:s.document_approval_id})]})};function xe(){const{post:s,processing:o}=T();return{restoreVersion:t=>{s(route("document.restore_version",{version:t}),{onSuccess:()=>{D.show({message:"Document version restored successfully.",color:"green"})},onError:()=>{D.show({message:"Failed to restore document version.",color:"red"})}})},processing:o}}function je(){const{delete:s,processing:o}=T();return{deleteVersion:t=>{s(route("document.delete_version",{version:t}),{onSuccess:()=>{D.show({message:"Document version deleted successfully.",color:"green"})},onError:()=>{D.show({message:"Failed to delete document version.",color:"red"})}})},processing:o}}const De=({versions:s})=>{const{restoreVersion:o}=xe(),{deleteVersion:r}=je();return e.jsx(Y,{columns:[{accessor:"name",title:"Name"},{accessor:"uploaded_at",title:"Uploaded At"},{accessor:"actions",title:"Actions",render:t=>e.jsxs(k,{gap:4,children:[e.jsx(I,{variant:"subtle",onClick:()=>o(t.id),children:e.jsx(de,{size:16})}),e.jsx(I,{variant:"subtle",color:"red",onClick:()=>r(t.id),children:e.jsx(P,{size:16})}),e.jsx("a",{href:t.file_path,download:!0,children:e.jsx(I,{variant:"subtle",children:e.jsx(ae,{size:16})})})]})}],records:s,highlightOnHover:!0,verticalSpacing:"sm",horizontalSpacing:"sm"})};function Ue(s){const{data:o,post:r,reset:t,processing:a,errors:l,clearErrors:n}=T({document_item_id:s,file:null});return{uploadVersion:p=>{if(!p){D.show({message:"No file selected.",color:"red"});return}o.file=p,r(`/document/${s}/versions`,{onSuccess:()=>{D.show({message:"Document version uploaded successfully.",color:"green"}),t()},onError:()=>{D.show({message:"Failed to upload document version.",color:"red"})},onFinish:()=>{n()}})},processing:a,errors:l}}const Le=({document:s,itemAncestors:o,activityLog:r})=>{const{openModal:t}=V(),{uploadVersion:a,processing:l,errors:n}=Ue(s.item_id),U=p=>{p&&a(p)};return e.jsxs(re,{children:[e.jsx(Z,{title:"Document Properties"}),e.jsx(ee,{px:8,py:8,mb:48,children:e.jsx(oe,{ancestors:o})}),e.jsxs(G,{children:[e.jsx(G.Col,{span:8,children:e.jsxs(N,{px:8,py:8,gap:48,mb:48,children:[e.jsxs(k,{children:[e.jsx(ce,{size:56,stroke:1,color:"gray"}),e.jsx(m,{fw:500,children:s.name})]}),e.jsxs(k,{justify:"space-between",w:700,children:[e.jsxs("div",{children:[e.jsx(m,{size:"sm",fw:"bold",children:"Document ID"}),e.jsx(m,{size:"sm",children:s.item_id})]}),e.jsxs("div",{children:[e.jsx(m,{size:"sm",fw:"bold",children:"Date"}),e.jsx(m,{size:"sm",children:s.created_at})]}),e.jsxs("div",{children:[e.jsx(m,{size:"sm",fw:"bold",children:"Document Number"}),e.jsx(m,{size:"sm",children:s.document_number})]})]}),e.jsxs(N,{gap:12,children:[s.versions.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(m,{size:"sm",fw:"bold",children:"Document Versions"}),e.jsx(De,{versions:s.versions})]}),e.jsx(m,{size:"sm",fw:"bold",children:"Audit Log"}),e.jsx(Y,{textSelectionDisabled:!0,columns:[{accessor:"date"},{accessor:"time"},{accessor:"user_name",title:"User"},{accessor:"description",title:"Action"}],records:r,highlightOnHover:!0,verticalSpacing:"lg",horizontalSpacing:"xl",withTableBorder:!0})]})]})}),e.jsx(G.Col,{span:3,offset:1,children:e.jsxs(se,{withBorder:!0,p:20,children:[e.jsx(m,{c:"dimmed",fw:500,children:"Options"}),e.jsx(L,{onChange:U,children:p=>e.jsx(y,{...p,variant:"subtle",color:"blue.5",fullWidth:!0,justify:"left",leftSection:e.jsx(te,{size:18}),children:"Upload New Version"})}),e.jsxs(y,{variant:"subtle",color:"blue.5",leftSection:e.jsx(ne,{size:18}),fullWidth:!0,justify:"left",onClick:()=>{t(s.document_approval_id?"updateDocumentApproval":"createDocumentApproval")},children:[s.document_approval_id?"View":"Start"," Approval Process"]})]})})]}),e.jsx(ue,{document:s}),e.jsx(ge,{document:s})]})};export{Le as default};
