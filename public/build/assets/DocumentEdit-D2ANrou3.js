import{f as de,u as le,i as re,d as _,j as e,M as W,e as ie,L as ce,n as F,W as ue,Y as me,B as pe,y as he}from"./app-Be6U1Dc8.js";import{u as y,a as Y,b as $,A as xe}from"./Authenticated-hQH3hORN.js";import{I as fe}from"./ItemBreadcrumbs-DoEBBp7D.js";import{u as je}from"./use-fetch-metadata-C0cIsteh.js";import{u as q,C as b}from"./Combobox-BzCSAeDM.js";import{S as v}from"./Stack-zxFT2Oc1.js";import{I as E}from"./InputBase-DUCm8-Wn.js";import{G as w,D as ge,c as J}from"./NotificationMenu-DL9b0tvo.js";import{B as M}from"./Button-D9h5vimS.js";import{T as R}from"./TextInput-8_pOHK7P.js";import{A}from"./IconUser-BfhP9fWZ.js";import{A as _e,I as ve}from"./IconAlertCircle-GtehlEbF.js";import{T as g,F as De}from"./OfficeLogo-BgjFk65O.js";import{u as be,a as Ce}from"./use-resolved-styles-api-D7z3oZkW.js";import{g as Me,a as we,O as Se}from"./OptionsDropdown-C0aY907v.js";import{u as ye,I as Ae}from"./use-show-items-for-moving-DkTASEA5.js";import{I as Ie}from"./IconEdit-BzfbtSSv.js";import{T as Oe}from"./Textarea-D6Scmjm5.js";import{D as ke}from"./DatePickerInput-BuR_wsd4.js";import"./Popover-DNH91axH.js";import"./get-sorted-breakpoints-CzoFm_tl.js";import"./Anchor-Xqcd2skh.js";import"./CheckIcon-RZhGPBCj.js";import"./clamp-DTmYCdls.js";const Pe={},T=de((a,c)=>{const s=le("Autocomplete",Pe,a),{classNames:d,styles:l,unstyled:o,vars:n,dropdownOpened:p,defaultDropdownOpened:m,onDropdownClose:x,onDropdownOpen:r,onFocus:h,onBlur:t,onClick:u,onChange:f,data:i,value:C,defaultValue:I,selectFirstOptionOnChange:O,onOptionSubmit:k,comboboxProps:K,readOnly:P,disabled:V,filter:Q,limit:X,withScrollArea:Z,maxDropdownHeight:ee,size:B,id:te,renderOption:ae,autoComplete:se,scrollAreaProps:oe,...S}=s,L=re(te),N=Me(i),ne=we(N),[z,U]=be({value:C,defaultValue:I,finalValue:"",onChange:f}),D=q({opened:p,defaultOpened:m,onDropdownOpen:r,onDropdownClose:()=>{x==null||x(),D.resetSelectedOption()}}),{resolvedClassNames:G,resolvedStyles:H}=Ce({props:s,styles:l,classNames:d});return _.useEffect(()=>{O&&D.selectFirstOption()},[O,z]),e.jsxs(b,{store:D,__staticSelector:"Autocomplete",classNames:G,styles:H,unstyled:o,readOnly:P,onOptionSubmit:j=>{k==null||k(j),U(ne[j].label),D.closeDropdown()},size:B,...K,children:[e.jsx(b.Target,{autoComplete:se,children:e.jsx(E,{ref:c,...S,size:B,__staticSelector:"Autocomplete",disabled:V,readOnly:P,value:z,onChange:j=>{U(j.currentTarget.value),D.openDropdown(),O&&D.selectFirstOption()},onFocus:j=>{D.openDropdown(),h==null||h(j)},onBlur:j=>{D.closeDropdown(),t==null||t(j)},onClick:j=>{D.openDropdown(),u==null||u(j)},classNames:G,styles:H,unstyled:o,id:L})}),e.jsx(Se,{data:N,hidden:P||V,filter:Q,search:z,limit:X,hiddenWhenEmpty:!0,withScrollArea:Z,maxDropdownHeight:ee,unstyled:o,labelId:S.label?`${L}-label`:void 0,"aria-label":S.label?void 0:S["aria-label"],renderOption:ae,scrollAreaProps:oe})]})});T.classes={...E.classes,...b.classes};T.displayName="@mantine/core/Autocomplete";const ze=({onAdd:a})=>{const{modals:c,closeModal:s}=y(),d=c.addDocumentMetadata,{metadataList:l}=je(),[o,n]=_.useState(null),p=q({onDropdownClose:()=>p.resetSelectedOption()}),m=()=>{o&&(a(o),s("addDocumentMetadata"),n(null))},x=l.map(r=>e.jsx(b.Option,{value:r.metadata_id.toString(),children:r.name},r.metadata_id));return e.jsx(W,{opened:d,onClose:()=>s("addDocumentMetadata"),title:"Add Custom Metadata",children:e.jsxs(v,{gap:16,children:[e.jsxs(b,{store:p,onOptionSubmit:r=>{const h=l.find(t=>t.metadata_id.toString()===r)||null;n(h),p.closeDropdown()},children:[e.jsx(b.Target,{children:e.jsx(E,{component:"button",type:"button",rightSection:e.jsx(b.Chevron,{}),onClick:()=>p.toggleDropdown(),children:o?o.name:"Select Metadata"})}),e.jsx(b.Dropdown,{children:e.jsx(b.Options,{children:x})})]}),e.jsxs(w,{justify:"flex-end",children:[e.jsx(M,{variant:"outline",onClick:()=>s("addDocumentMetadata"),children:"Cancel"}),e.jsx(M,{onClick:m,disabled:!o,children:"Add"})]})]})})};function Fe(a){const[c,s]=_.useState([]),[d,l]=_.useState(!1),[o,n]=_.useState(null);return _.useEffect(()=>{(async()=>{if(a===null){s([]);return}l(!0);try{const m=await ie.get(route("metadata.predefined-values",{metadata:a}));s(m.data.predefined_values),n(null)}catch(m){n("Failed to fetch predefined values."),console.error(m)}finally{l(!1)}})()},[a]),{predefinedValues:c,loading:d,error:o}}const Re=({metadata:a,requiredMetadata:c,onAdd:s,onUpdate:d,onChange:l,onDelete:o})=>{const{openModal:n}=y();_.useState(null);const p=t=>{s&&s(t)},m=()=>{n("addDocumentMetadata")},x=t=>{const u=a[t],f=a.filter((i,C)=>C!==t);d&&d(f),o&&u.metadata_id!==0&&o(u.metadata_id)},r=(t,u,f)=>{const i=a.map((C,I)=>I===t?{...C,[u]:f}:C);l&&l(i)},h=_.useMemo(()=>{const t=a.map(u=>u.metadata_id);return c.filter(u=>!t.includes(u.metadata_id))},[a,c]);return e.jsxs(v,{children:[a.map((t,u)=>e.jsxs(w,{justify:"space-between",align:"flex-end",children:[e.jsx(R,{disabled:!0,label:"Name",placeholder:"Metadata name",value:t.name,onChange:f=>r(u,"name",f.target.value)}),e.jsx(Ee,{metadataId:t.metadata_id,value:t.value||"",onChange:f=>r(u,"value",f)}),e.jsx(A,{color:"red",variant:"subtle",size:"lg",onClick:()=>x(u),children:e.jsx(Y,{size:16})})]},t.metadata_id||u)),h.length>0&&e.jsx(v,{gap:"xs",children:h.map(t=>e.jsx(_e,{icon:e.jsx(ve,{size:16}),title:`${t.name} is missing`,color:"orange",variant:"light"},t.metadata_id))}),e.jsx(M,{variant:"light",onClick:m,leftSection:e.jsx($,{size:14}),children:"Add New Tag"}),e.jsx(ze,{onAdd:t=>p({metadata_id:t.metadata_id,name:t.name,value:""})})]})},Ee=({metadataId:a,value:c,onChange:s})=>{const{predefinedValues:d,loading:l,error:o}=Fe(a);return l?e.jsx(ce,{size:"sm"}):o?e.jsx(g,{c:"red",size:"sm",children:o}):e.jsx(T,{label:"Value",data:d.map(n=>({value:n.predefined_value,label:n.predefined_value})),value:c,onChange:n=>s(n||"")})},Te=({onAdd:a})=>{const{modals:c,closeModal:s}=y(),d=c.relatedDocumentModal,[l,o]=_.useState(null),{data:n,loading:p,error:m}=ye(l,d),x=t=>{o(t)},r=()=>{n.itemParent&&n.itemParent.parent_id?o(n.itemParent.parent_id):o(null)},h=t=>{a(t),s("relatedDocumentModal"),o(null)};return e.jsx(W,{opened:d,onClose:()=>s("relatedDocumentModal"),title:e.jsx(g,{fw:500,children:"Select Related Document"}),size:"lg",children:e.jsxs(v,{gap:"md",children:[e.jsxs(w,{children:[l&&e.jsx(A,{onClick:r,children:e.jsx(Ae,{size:16})}),e.jsx(g,{c:"dark.5",fw:500,children:"Choose Related Document"})]}),e.jsx(ge,{}),p?e.jsx(g,{children:"Loading..."}):m?e.jsx(g,{color:"red",children:m}):e.jsx(v,{gap:"sm",style:{maxHeight:400,overflowY:"auto"},children:n.itemContents.map(t=>e.jsxs(w,{gap:"sm",style:{cursor:"pointer"},onClick:()=>{t.type==="folder"?x(t.item_id):h({item_id:t.item_id,name:t.name})},children:[e.jsx(J,{mime:t.mime??"",isFolder:t.type==="folder"}),e.jsx(g,{children:t.name})]},t.item_id))}),e.jsxs(w,{justify:"flex-end",mt:"md",children:[e.jsx(M,{variant:"outline",onClick:()=>s("relatedDocumentModal"),children:"Cancel"}),e.jsx(M,{onClick:()=>{l?s("relatedDocumentModal"):F.show({position:"top-center",message:"Please select a document to relate.",color:"red"})},disabled:!l,children:"Relate"})]})]})})},Ve=({relatedDocuments:a,onChange:c})=>{const{openModal:s}=y(),d=o=>{const n=[...a,o];c&&c(n)},l=o=>{const n=a.filter((p,m)=>m!==o);c&&c(n)};return e.jsxs(v,{children:[a.map((o,n)=>e.jsxs(w,{justify:"space-between",align:"flex-end",style:{border:"1px solid #E5E7EB",borderRadius:"8px",padding:"8px"},children:[e.jsx(g,{children:o.name}),e.jsx(A,{color:"red",variant:"subtle",size:"lg",onClick:()=>l(n),children:e.jsx(Y,{size:16})})]},o.item_id)),e.jsx(Te,{onAdd:d}),e.jsx(M,{variant:"light",onClick:()=>s("relatedDocumentModal"),leftSection:e.jsx($,{size:14}),children:"Add Related Document"})]})};function Be({document:a,onSuccess:c}){const{data:s,setData:d,put:l,processing:o,errors:n,reset:p,clearErrors:m}=ue({name:a.name,document_number:a.document_number||"",description:a.description||"",due_date:a.due_date||"",update_metadata:a.metadata.map(r=>({metadata_id:r.metadata_id,name:r.name,value:r.value})),delete_metadata:[],related_documents:a.related_documents.map(r=>({item_id:r.item_id,name:r.name}))});return{data:s,setData:d,handleUpdateDocument:r=>{r.preventDefault(),l(route("document.save",a.item_id),{onSuccess:()=>{F.show({position:"top-center",message:"Document updated successfully",color:"green"})},onError:h=>{F.show({position:"top-center",message:"Failed to update document",color:"red"})},onFinish:()=>m()})},processing:o,errors:n,reset:p}}function ct({document:a,itemAncestors:c}){const{data:s,setData:d,handleUpdateDocument:l,processing:o,errors:n,reset:p}=Be({document:a}),[m,x]=_.useState([]),r=i=>{d("update_metadata",[...s.update_metadata||[],i])},h=i=>{s.update_metadata=i},t=i=>{d("update_metadata",i)},u=i=>{x(C=>[...C,i]),d("delete_metadata",[...s.delete_metadata||[],{metadata_id:i}])},f=i=>{d("related_documents",i)};return e.jsxs(xe,{children:[e.jsx(me,{title:"Document Properties"}),e.jsx(pe,{px:8,py:8,children:e.jsx(fe,{ancestors:c})}),e.jsxs(v,{px:8,py:8,gap:24,w:550,mb:72,children:[e.jsxs(w,{mt:24,align:"center",children:[e.jsx(J,{mime:a.mime,isFolder:!1,reviewStatus:a.review_status,approvalStatus:a.approval_status}),e.jsx(g,{fw:500,children:s.name}),e.jsx(A,{variant:"subtle",color:"gray",children:e.jsx(Ie,{size:24})})]}),e.jsxs("form",{onSubmit:l,children:[e.jsxs(v,{gap:12,children:[e.jsx(R,{label:"Document Number",name:"document_number",value:s.document_number,onChange:i=>d("document_number",i.target.value),placeholder:"Enter document number"}),e.jsx(R,{type:"text",label:"Created At",value:a.created_at,disabled:!0}),e.jsx(Oe,{label:"Description",autosize:!0,minRows:4,maxRows:6,placeholder:"Enter description",value:s.description,onChange:i=>d("description",i.target.value)}),e.jsx(ke,{label:"Due Date",placeholder:"Select due date",value:s.due_date?new Date(s.due_date):void 0,onChange:i=>d("due_date",(i==null?void 0:i.toISOString())??void 0)})]}),e.jsxs(v,{gap:12,mt:16,children:[e.jsx(g,{size:"sm",fw:500,children:"Custom Tags"}),e.jsx(Re,{metadata:s.update_metadata??[],requiredMetadata:a.required_folder_metadata,onAdd:r,onUpdate:h,onChange:t,onDelete:u})]}),e.jsxs(v,{gap:12,mt:16,children:[e.jsx(g,{size:"sm",fw:500,children:"Related Documents"}),e.jsx(Ve,{relatedDocuments:s.related_documents||[],onChange:f})]}),e.jsxs(De,{align:"center",justify:"end",mt:16,children:[e.jsx(M,{variant:"light",onClick:()=>he.visit(route("document.show",{document:a.item_id})),children:"Cancel"}),e.jsx(M,{ml:12,type:"submit",loading:o,children:"Save Changes"})]})]})]})]})}export{ct as default};
