import{e as N,W as ne,d as b,j as e,M as O,L as re,n as q,Y as se,y as de}from"./app-BEodKt-G.js";import{Y as ie}from"./index-CCeQeG64.js";import{u as z,a as U,b as Y,A as ce}from"./Authenticated-CedN_kzA.js";import{u as ue,a as me}from"./use-search-datatable-WtqS-aZe.js";import{u as pe,I as he}from"./use-fetch-existing-metadata-column-vph7_454.js";import{F as y,T as B}from"./OfficeLogo-QrwYQ9xU.js";import{A as ge,I as xe}from"./IconAlertCircle-_vnmEl_-.js";import{S as k}from"./Stack-b64hFvEW.js";import{G as M,c as ve}from"./NotificationMenu-Bef11bW4.js";import{S as w}from"./Select-KQZ3_Zng.js";import{A as V}from"./IconUser-LOwS_dVd.js";import{B as v}from"./Button-Bc2BCUyH.js";import{T as _e}from"./TextInput-HCVk_Cwn.js";import{u as je}from"./use-document-properties-ZQNqolY1.js";import{D as T}from"./DatePickerInput-DdNrSIRP.js";import{I as G}from"./IconFilter-CGUXU0pV.js";import{I as fe}from"./IconDownload-DhTBuW6x.js";import"./Checkbox-Cdbhhnny.js";import"./InputBase-B11NYywG.js";import"./use-resolved-styles-api-COBSDX6X.js";import"./CheckIcon-ryLvwX6E.js";import"./Popover-DHwVg9bw.js";import"./get-sorted-breakpoints-DMDaKoNH.js";import"./OptionsDropdown-DOwH-Dqd.js";import"./Combobox-Bm466Os8.js";import"./clamp-DTmYCdls.js";function Ce(){return{generateReport:async j=>{var s;try{const r=await N.post(route("report.generate"),{folder_item_id:j}),{url:c,filename:m}=r.data;if(c){const l=document.createElement("a");l.href=c,l.download=m,document.body.appendChild(l),l.click(),document.body.removeChild(l)}else console.error("No URL returned for the report.")}catch(r){console.error("Error generating report:",((s=r.response)==null?void 0:s.data)||r.message)}},generateDashboardReport:async j=>{var s;try{const r=await N.post(route("report.generateDashboard"),j),{url:c,filename:m}=r.data;if(c){const l=document.createElement("a");l.href=c,l.download=m,document.body.appendChild(l),l.click(),document.body.removeChild(l)}else console.error("No URL returned for the dashboard report.")}catch(r){console.error("Error generating dashboard report:",((s=r.response)==null?void 0:s.data)||r.message)}}}}const be=({availableMetadata:_,existingMetadataIds:u})=>{const{modals:j,closeModal:s}=z(),r=j.selectDashboardMetadataColumns,{existingMetadataColumns:c,loading:m,error:l}=pe({folderId:"",isOpen:r}),{data:d,setData:h,post:f,processing:S,errors:n,reset:t}=ne({metadata_columns:[{id:Date.now(),value:""}],metadata_ids:[]});b.useEffect(()=>{if(u.length>0){const i=u.map(o=>({id:Date.now()+o,value:o.toString()}));h("metadata_columns",i)}},[u,r]),b.useEffect(()=>{const i=d.metadata_columns.map(o=>parseInt(o.value)).filter(o=>!isNaN(o));h("metadata_ids",i)},[d.metadata_columns]);const C=()=>{h("metadata_columns",[...d.metadata_columns,{id:Date.now(),value:""}])},x=i=>{h("metadata_columns",d.metadata_columns.filter(o=>o.id!==i))},A=(i,o)=>{const F=d.metadata_columns.map(I=>I.id===i?{...I,value:o}:I);h("metadata_columns",F)},R=i=>{i.preventDefault(),d.metadata_columns.map(o=>parseInt(o.value)).filter(o=>!isNaN(o)),f(route("dashboard.selectMetadataColumn"),{preserveScroll:!0,onSuccess:()=>{s("selectDashboardMetadataColumns"),q.show({position:"top-center",title:"Success",message:"Metadata columns selected successfully",color:"green"}),t()},onError:()=>{q.show({position:"top-center",title:"Error",message:"Failed to select metadata columns",color:"red"})}})};return e.jsx(O,{opened:r,onClose:()=>{s("selectDashboardMetadataColumns"),t()},title:"Select Metadata Columns",size:550,children:m?e.jsx(y,{justify:"center",align:"center",h:"100%",children:e.jsx(re,{})}):l?e.jsx(ge,{icon:e.jsx(xe,{size:16}),title:"Error",color:"red",children:l}):e.jsxs("form",{onSubmit:R,children:[e.jsxs(k,{gap:16,children:[e.jsx(B,{children:"Select the metadata columns you want to display in the dashboard report:"}),d.metadata_columns.map(i=>e.jsxs(M,{justify:"space-between",align:"flex-end",children:[e.jsx(w,{placeholder:"Pick a metadata column",data:_.map(o=>({value:o.metadata_id.toString(),label:o.name})),value:i.value,onChange:o=>A(i.id,o||""),w:"90%",required:!0}),d.metadata_columns.length>1&&e.jsx(V,{color:"red",variant:"subtle",onClick:()=>x(i.id),children:e.jsx(U,{size:18})})]},i.id)),e.jsx(y,{justify:"flex-start",children:e.jsx(v,{variant:"subtle",color:"blue.5",leftSection:e.jsx(Y,{size:18}),onClick:C,children:"Add New Column"})})]}),e.jsxs(y,{align:"center",justify:"end",mt:16,children:[e.jsx(v,{variant:"outline",onClick:()=>{s("selectDashboardMetadataColumns"),t()},children:"Cancel"}),e.jsx(v,{ml:12,type:"submit",loading:S,children:"Save"})]})]})})},De=({availableMetadata:_,onApplyFilters:u})=>{const{modals:j,closeModal:s}=z(),r=j.metadataFilterModal,[c,m]=b.useState([{id:Date.now(),field:"",operator:"",value:""}]),l=()=>{m([...c,{id:Date.now(),field:"",operator:"",value:""}])},d=n=>{m(c.filter(t=>t.id!==n))},h=(n,t,C)=>{m(c.map(x=>x.id===n?{...x,[t]:C}:x))},f=()=>{const n=c.map(({field:t,operator:C,value:x})=>({field:t,operator:C,value:x}));u(n),s("metadataFilterModal")},S=()=>{m([{id:Date.now(),field:"",operator:"",value:""}]),u([]),s("metadataFilterModal")};return e.jsx(O,{opened:r,onClose:()=>s("metadataFilterModal"),title:"Filter by Metadata",size:"lg",children:e.jsxs(k,{children:[c.map(n=>e.jsxs(M,{align:"flex-end",children:[e.jsx(w,{label:"Field",placeholder:"Select field",data:_.map(t=>({value:t.name,label:t.name})),value:n.field,onChange:t=>h(n.id,"field",t||""),required:!0,style:{flex:1}}),e.jsx(w,{label:"Operator",placeholder:"Select operator",data:[{value:"includes",label:"Includes"},{value:"excludes",label:"Excludes"},{value:"is",label:"Is"},{value:"is_not",label:"Is Not"}],value:n.operator,onChange:t=>h(n.id,"operator",t||""),required:!0,style:{flex:1}}),e.jsx(_e,{label:"Value",placeholder:"Enter value",value:n.value,onChange:t=>h(n.id,"value",t.target.value),required:!0,style:{flex:2}}),c.length>1&&e.jsx(V,{color:"red",variant:"subtle",onClick:()=>d(n.id),children:e.jsx(U,{size:16})})]},n.id)),e.jsx(v,{variant:"light",color:"blue.5",leftSection:e.jsx(Y,{size:18}),onClick:l,children:"Add New Filter"}),e.jsxs(y,{justify:"flex-end",mt:"md",children:[e.jsx(v,{variant:"outline",onClick:S,children:"Clear Filters"}),e.jsx(v,{ml:12,onClick:f,children:"Apply Filters"})]})]})})},Qe=({documents:_,filters:u,selectedMetadata:j,availableMetadata:s,existingMetadataIds:r,users:c})=>{const[m,l]=b.useState(u.document_status),[d,h]=b.useState(u.start_date?new Date(u.start_date):null),[f,S]=b.useState(u.end_date?new Date(u.end_date):null),[n,t]=b.useState(null),[C,x]=b.useState(null),[A,R]=b.useState(u.metadata_filters||[]),{openDocument:i}=je(),{search:o,setSearch:F,handleSearch:I}=ue("","/dashboard/reports"),{page:L,setPage:H,handlePageChange:Se}=me(_.current_page),{generateDashboardReport:W}=Ce(),{openModal:P}=z(),D=a=>{const p={document_status:a.document_status!==void 0?a.document_status:m,start_date:a.start_date!==void 0?a.start_date?new Date(a.start_date).toLocaleDateString("en-CA"):null:d?d.toLocaleDateString("en-CA"):null,end_date:a.end_date!==void 0?a.end_date?new Date(a.end_date).toLocaleDateString("en-CA"):null:f?f.toLocaleDateString("en-CA"):null,uploader:a.uploader!==void 0?a.uploader:n,due_in:a.due_in!==void 0?a.due_in:C,page:a.page!==void 0?a.page:L,metadata_filters:a.metadata_filters!==void 0?a.metadata_filters.length>0?a.metadata_filters:void 0:A.length>0?A:void 0};Object.keys(p).forEach(g=>{(p[g]===null||p[g]===void 0||Array.isArray(p[g])&&p[g].length===0)&&delete p[g]}),de.get(route("dashboard.reports"),p,{replace:!0,preserveState:!0})},$=a=>{l(a),D({document_status:a,page:1})},J=a=>{h(a),D({start_date:a?a.toLocaleDateString("en-CA"):null,page:1})},K=a=>{S(a),D({end_date:a?a.toLocaleDateString("en-CA"):null,page:1})},Q=a=>{t(a),D({uploader:a,page:1})},X=a=>{x(a),D({due_in:a,page:1})},Z=a=>{H(a),D({page:a})},ee=()=>{const a={document_status:m,start_date:d?d.toLocaleDateString("en-CA"):null,end_date:f?f.toLocaleDateString("en-CA"):null,uploader:n,due_in:C,metadata_ids:r,metadata_filters:A};W(a)},ae=()=>{l(null),h(null),S(null),t(null),x(null),F(""),R([]),D({document_status:null,start_date:null,end_date:null,uploader:null,due_in:null,metadata_filters:[],search:""})},te=()=>j.map(a=>({accessor:`metadata_${a.metadata_id}`,title:a.name,render:p=>{var E;const g=(E=p.metadata)==null?void 0:E.find(le=>le.metadata_id===a.metadata_id);return g?g.value:"N/A"}})),oe=a=>{R(a),D({metadata_filters:a,page:1})};return e.jsxs(ce,{children:[e.jsx(se,{title:"Dashboard Report"}),e.jsxs(k,{px:8,gap:24,py:8,children:[e.jsx(M,{children:e.jsx(B,{component:"h2",size:"xl",color:"gray.8",children:"Dashboard Report"})}),e.jsxs(k,{children:[e.jsxs(M,{align:"flex-end",children:[e.jsxs(y,{gap:"md",justify:"flex-start",align:"flex-end",direction:"row",wrap:"wrap",children:[e.jsx(w,{placeholder:"Select document status",value:m,onChange:$,data:[{value:"reviewal_accepted",label:"Review Accepted"},{value:"reviewal_rejected",label:"Review Rejected"},{value:"reviewal_pending",label:"Review Pending"},{value:"approval_accepted",label:"Approval Accepted"},{value:"approval_rejected",label:"Approval Rejected"},{value:"approval_pending",label:"Approval Pending"}],style:{width:200}}),e.jsx(w,{placeholder:"Select uploader",value:n,onChange:Q,data:c.map(a=>({value:a.id.toString(),label:a.name})),style:{width:200}}),e.jsx(w,{placeholder:"Select due in",value:C,onChange:X,data:[{value:"7",label:"Due in 7 days"},{value:"30",label:"Due in 30 days"},{value:"60",label:"Due in 60 days"}],style:{width:200}}),e.jsx(T,{placeholder:"Start Date",value:d,onChange:J,style:{width:200},required:!0}),e.jsx(T,{placeholder:"End Date",value:f,onChange:K,style:{width:200},required:!0}),e.jsx(v,{onClick:()=>P("selectDashboardMetadataColumns"),leftSection:e.jsx(he,{size:16}),variant:"subtle",color:"dark.5",children:"Columns"}),e.jsx(v,{onClick:()=>P("metadataFilterModal"),leftSection:e.jsx(G,{size:16}),variant:"subtle",color:"gray.5",children:"Metadata Filters"})]}),e.jsxs(y,{gap:"sm",children:[e.jsx(v,{onClick:ae,variant:"subtle",color:"gray",leftSection:e.jsx(G,{size:16}),children:"Clear Filters"}),e.jsx(v,{onClick:ee,leftSection:e.jsx(fe,{size:16}),color:"blue",variant:"subtle",children:"Generate Report"})]})]}),e.jsx(be,{availableMetadata:s,existingMetadataIds:r}),e.jsx(De,{availableMetadata:s,onApplyFilters:oe}),e.jsx(ie,{columns:[{accessor:"name",render:({mime:a,type:p,name:g,missing_required_metadata:E})=>e.jsxs(M,{align:"center",gap:12,children:[e.jsx(ve,{mime:a??"",isFolder:p==="folder",missingRequiredMetadata:E}),e.jsx("span",{children:g})]})},{accessor:"updated_at",title:"Last Modified"},{accessor:"due_in",title:"Due In"},...te()],records:_.data,totalRecords:_.total,recordsPerPage:_.per_page,page:L,onPageChange:Z,highlightOnHover:!0,verticalSpacing:"lg",horizontalSpacing:"xl",customRowAttributes:({type:a,id:p})=>({onDoubleClick:g=>{g.button===0&&i(p)}})})]})]})]})};export{Qe as default};
