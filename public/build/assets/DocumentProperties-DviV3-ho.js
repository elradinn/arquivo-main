import{b as _,u as K,h as Q,j as e,i as X,W as M,n as w,M as G,c as Z,Y as ee,B as se,P as re}from"./app-Bi-kKfSQ.js";import{u as T,a as P,b as B,A as oe}from"./Authenticated-C_lZwoKT.js";import{Y as W}from"./index-BALgSnzC.js";import{I as te}from"./ItemBreadcrumbs-BJ2dT-ld.js";import{u as Y,R as V,I as ne,a as le}from"./use-fetch-users-approval-role-BRZs4JWr.js";import{T as v,F as $}from"./OfficeLogo-2ZaB1g-B.js";import{S as N}from"./Stack-D9KjGeyZ.js";import{G as C,A as E,S as ae}from"./NotificationMenu-C937_Mzw.js";import{T as q}from"./Textarea-DetDTP7-.js";import{S as H}from"./Select-ChKntED6.js";import{B as S}from"./Button-1yfY3Uus.js";import{c as L}from"./IconUser-DGEFyDH_.js";import{I as ce}from"./IconDownload-C8ZGmfe3.js";import{G as O}from"./Grid-C2RbmrfU.js";import{I as ie}from"./IconFile-BRMhlduA.js";import"./TextInput-D9HeubEm.js";import"./InputBase-UL63YNSc.js";import"./Popover-DE1Ul7Ry.js";import"./use-uncontrolled-BwiKmmNw.js";import"./get-sorted-breakpoints-Cse3ButY.js";import"./Checkbox-3zVWk8bN.js";import"./CheckIcon-DsGROgfh.js";import"./Anchor-CbJtCjSK.js";import"./Combobox-BOP9bz1U.js";import"./get-base-value-JqT_q0U7.js";const de={multiple:!1},J=_.forwardRef((s,t)=>{const{onChange:o,children:n,multiple:a,accept:c,name:l,form:A,resetRef:p,disabled:R,capture:b,inputProps:z,...d}=K("FileButton",de,s),x=_.useRef(),u=()=>{var f;!R&&((f=x.current)==null||f.click())},U=f=>{o(a?Array.from(f.currentTarget.files):f.currentTarget.files[0]||null)};return Q(p,()=>{x.current.value=""}),e.jsxs(e.Fragment,{children:[n({onClick:u,...d}),e.jsx("input",{style:{display:"none"},type:"file",accept:c,multiple:a,onChange:U,ref:X(t,x),name:l,form:A,capture:b,...z})]})});J.displayName="@mantine/core/FileButton";/**
 * @license @tabler/icons-react v3.11.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var pe=L("outline","eye","IconEye",[["path",{d:"M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0",key:"svg-0"}],["path",{d:"M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6",key:"svg-1"}]]);/**
 * @license @tabler/icons-react v3.11.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ue=L("outline","refresh","IconRefresh",[["path",{d:"M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4",key:"svg-0"}],["path",{d:"M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4",key:"svg-1"}]]);function me({documentId:s}){const[t,o]=_.useState("reviewal"),{closeModal:n,modals:a}=T(),c=Y(t,a.createDocumentApproval),{data:l,setData:A,post:p,processing:R,errors:b,reset:z}=M({document_id:"",resolution:"",destination:"",type:"reviewal",users:[]}),[d,x]=_.useState([]),u=c.length;_.useEffect(()=>{x([])},[t,c]);const U=j=>{j.preventDefault();const y=d.map(i=>parseInt(i.selectedUser)).filter(i=>!isNaN(i));l.document_id=s??"",l.users=y.map(i=>({user_id:i.toString()})),p(route("document_approvals.store"),{preserveScroll:!0,onSuccess:()=>{n("createDocumentApproval"),w.show({message:"Document approval process created",color:"green"})},onError:()=>{w.show({message:"Something went wrong",color:"red"})},onFinish:()=>z()})},m=()=>{d.length<u&&x([...d,{selectedUser:""}])},f=()=>{const j=d.map(r=>r.selectedUser),i=c.filter(r=>!j.includes(r.id.toString())).map(r=>({selectedUser:r.id.toString()}));x([...d,...i])},D=j=>{const y=[...d];y.splice(j,1),x(y)},g=(j,y)=>{const i=[...d];i[j].selectedUser=y||"",x(i)},F=d.map(j=>j.selectedUser).filter(j=>j!=="");return{data:l,setData:A,createApprovalSubmit:U,processing:R,errors:b,users:d,setDocumentApprovalType:o,addUser:m,removeUser:D,handleUserChange:g,addAllUsers:f,maxUsers:u,selectedUserIds:F,fetchedUsers:c}}const he=({document:s})=>{const{data:t,setData:o,createApprovalSubmit:n,processing:a,errors:c,users:l,setDocumentApprovalType:A,addUser:p,removeUser:R,handleUserChange:b,addAllUsers:z,maxUsers:d,selectedUserIds:x,fetchedUsers:u}=me({documentId:s==null?void 0:s.item_id}),{modals:U,closeModal:m}=T(),f=D=>u.filter(g=>!x.includes(g.id.toString())||g.id.toString()===l[D].selectedUser).map(g=>({value:g.id.toString(),label:`${g.name} (${g.email})`}));return e.jsx(G,{opened:U.createDocumentApproval,onClose:()=>m("createDocumentApproval"),title:e.jsx(v,{fw:"bold",size:"lg",children:"Create Document Approval Process"}),size:550,children:e.jsxs("form",{onSubmit:n,children:[e.jsxs(N,{gap:16,children:[e.jsx(v,{size:"sm",color:"dimmed",children:"Routinely directs any uploaded file in this folder through a predefined document approval process"}),e.jsx(V.Group,{name:"status",value:t.type,onChange:D=>{o("type",D),A(D)},children:e.jsxs(C,{mt:"xs",children:[e.jsx(V,{value:"reviewal",label:"Review"}),e.jsx(V,{value:"approval",label:"Approval"})]})}),e.jsx(q,{label:"Resolution",placeholder:"Your resolution for this approval",value:t.resolution??"",onChange:D=>o("resolution",D.target.value),error:c.resolution,autosize:!0,minRows:2,maxRows:4}),e.jsx(v,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),l.map((D,g)=>e.jsxs(C,{justify:"space-between",align:"flex-end",children:[e.jsx(H,{placeholder:"Select a user",data:f(g),value:D.selectedUser,onChange:F=>b(g,F),required:!0,style:{flex:1},allowDeselect:!1}),e.jsx(E,{color:"red",onClick:()=>R(g),title:"Remove User",children:e.jsx(P,{size:18})})]},g)),e.jsxs(C,{children:[l.length<d&&e.jsx(S,{variant:"subtle",color:"green",leftSection:e.jsx(B,{size:16}),onClick:p,disabled:l.length>=d,children:"Add User"}),x.length<d&&e.jsx(S,{variant:"subtle",color:"blue",leftSection:e.jsx(B,{size:16}),onClick:z,disabled:l.length>=d,children:"Add All Users"})]})]}),e.jsxs($,{align:"center",justify:"end",mt:16,children:[e.jsx(S,{variant:"light",onClick:()=>m("createDocumentApproval"),children:"Cancel"}),e.jsx(S,{ml:12,type:"submit",loading:a,children:"Create"})]})]})})};function ve({documentApprovalId:s,isOpen:t}){const[o,n]=_.useState(null);_.useEffect(()=>{s&&t&&a(s)},[s,t]);const a=async c=>{try{const l=await Z.get(`/document_approval/${c}/update`);n(l.data)}catch(l){console.error("Error fetching document approval",l)}};return o}function fe({documentApprovalId:s,isOpen:t}){const[o,n]=_.useState("reviewal"),a=ve({documentApprovalId:s,isOpen:t}),c=Y(o,t),{closeModal:l}=T(),{data:A,setData:p,put:R,processing:b,errors:z,reset:d,clearErrors:x}=M({resolution:"",type:"",users:[]}),[u,U]=_.useState([]),m=c.length;_.useEffect(()=>{a&&(n(a.type||""),p({resolution:a.resolution||"",type:a.type||"",users:(a.document_user_approvals||[]).map(r=>({user_id:r.user_id}))}),U((a.document_user_approvals||[]).map(r=>({selectedUser:r.user_id.toString()}))))},[a,t]),_.useEffect(()=>{U([])},[o]);const f=()=>{l("viewDocumentApproval"),d(),x()},D=r=>{r.preventDefault(),A.users=u.map(h=>parseInt(h.selectedUser)).filter(h=>!isNaN(h)).map(h=>({user_id:h.toString()})),R(route("document_approvals.update",s),{onSuccess:()=>{f(),w.show({message:"Document approval updated successfully",color:"green"})},onError:()=>{w.show({message:"Something went wrong",color:"red"})},onFinish:()=>d()})},g=()=>{u.length<m&&U([...u,{selectedUser:""}])},F=()=>{const r=u.map(I=>I.selectedUser),k=c.filter(I=>!r.includes(I.id.toString())).map(I=>({selectedUser:I.id.toString()}));U([...u,...k])},j=r=>{const h=[...u];h.splice(r,1),U(h)},y=(r,h)=>{const k=[...u];k[r].selectedUser=h||"",U(k)},i=u.map(r=>r.selectedUser).filter(r=>r!=="");return{data:A,setData:p,handleUpdateDocumentApproval:D,processing:b,errors:z,handleClose:f,users:u,documentApproval:a,setDocumentApprovalType:n,addUser:g,removeUser:j,handleUserChange:y,addAllUsers:F,maxUsers:m,selectedUserIds:i,fetchedUsers:c}}function ge({documentApprovalId:s,onDeleteSuccess:t}){const{delete:o,processing:n}=M();return{handleDeleteDocumentApproval:()=>{if(!s){w.show({message:"Document Approval ID is missing.",color:"red"});return}o(route("document_approvals.cancel",s),{onSuccess:()=>{w.show({message:"Document Approval deleted successfully.",color:"green"}),t()},onError:c=>{let l="Failed to delete document approval.";c&&Object.keys(c).length>0&&(l=c[Object.keys(c)[0]]),w.show({message:l,color:"red"})}})},processing:n}}const xe=({documentApprovalId:s})=>{const{modals:t,closeModal:o,openModal:n}=T(),a=t.confirmDeleteDocumentApproval,{handleDeleteDocumentApproval:c,processing:l}=ge({documentApprovalId:s,onDeleteSuccess:()=>{o("confirmDeleteDocumentApproval"),o("viewDocumentApproval")}});return e.jsxs(G,{opened:a,onClose:()=>o("confirmDeleteDocumentApproval"),title:e.jsx(v,{fw:"bold",size:"lg",children:"Confirm Delete"}),size:"sm",centered:!0,children:[e.jsx(v,{c:"gray.8",children:"Are you sure you want to cancel this document approval? This action cannot be undone."}),e.jsxs($,{align:"center",justify:"flex-end",mt:16,children:[e.jsx(S,{variant:"light",onClick:()=>{o("confirmDeleteDocumentApproval"),n("viewDocumentApproval")},children:"Cancel"}),e.jsx(S,{color:"red",ml:12,onClick:c,loading:l,children:"Delete"})]})]})},je=({document:s})=>{const{modals:t,closeModal:o,openModal:n}=T(),a=t.viewDocumentApproval,{data:c,setData:l,handleUpdateDocumentApproval:A,processing:p,errors:R,users:b,setDocumentApprovalType:z,addUser:d,removeUser:x,handleUserChange:u,addAllUsers:U,documentApproval:m,maxUsers:f,selectedUserIds:D,fetchedUsers:g}=fe({documentApprovalId:s==null?void 0:s.document_approval_id,isOpen:a}),F=i=>g.filter(r=>!D.includes(r.id.toString())||r.id.toString()===b[i].selectedUser).map(r=>({value:r.id.toString(),label:`${r.name} (${r.email})`})),j=m==null?void 0:m.document_user_approvals.some(i=>["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(i.user_state)),y=m==null?void 0:m.document_user_approvals.every(i=>["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(i.user_state));return e.jsxs(e.Fragment,{children:[e.jsx(G,{opened:a,onClose:()=>o("viewDocumentApproval"),title:e.jsx(v,{fw:"bold",size:"lg",children:"Document Workflow Process"}),size:550,children:e.jsxs("form",{onSubmit:A,children:[e.jsxs(N,{gap:16,children:[e.jsx(v,{size:"sm",children:"View the document workflow process for this document"}),!j&&e.jsx(V.Group,{name:"status",value:c.type,onChange:i=>{l("type",i),z(i)},children:e.jsxs(C,{mt:"xs",children:[e.jsx(V,{value:"reviewal",label:"Review"}),e.jsx(V,{value:"approval",label:"Approval"})]})}),e.jsx(q,{label:"Resolution",placeholder:"Your resolution for this approval",value:c.resolution??"",onChange:i=>l("resolution",i.target.value),error:R.resolution,autosize:!0,minRows:2,maxRows:4,readOnly:j}),e.jsx(v,{size:"sm",fw:500,mb:-8,children:"Users in this document approval"}),b.map((i,r)=>{const h=m==null?void 0:m.document_user_approvals.find(I=>I.user_id.toString()===i.selectedUser);console.log("userApproval",h);const k=h&&["Reviewal Accepted","Reviewal Rejected","Approval Accepted","Approval Rejected"].includes(h.user_state);return e.jsxs(C,{justify:"space-between",align:"flex-end",children:[e.jsxs(C,{children:[e.jsx(ae,{approvalStatus:h==null?void 0:h.user_state})," "]}),e.jsx(H,{placeholder:"Select a user",data:F(r),value:i.selectedUser,onChange:I=>u(r,I),required:!k,style:{flex:1},allowDeselect:!k,readOnly:k}),!k&&e.jsx(E,{color:"red",onClick:()=>x(r),title:"Remove User",children:e.jsx(P,{size:18})})]},r)}),!y&&e.jsxs(C,{children:[b.length<f&&e.jsx(S,{variant:"subtle",color:"green",leftSection:e.jsx(B,{size:16}),onClick:d,disabled:b.length>=f,children:"Add User"}),D.length<f&&e.jsx(S,{variant:"subtle",color:"blue",leftSection:e.jsx(B,{size:16}),onClick:U,disabled:b.length>=f,children:"Add All Users"})]})]}),e.jsxs($,{align:"center",justify:"end",mt:16,children:[e.jsx(S,{variant:"light",onClick:()=>o("viewDocumentApproval"),children:y?"Close":"Cancel"}),!y&&e.jsxs(e.Fragment,{children:[e.jsx(S,{ml:12,type:"submit",loading:p,children:"Update"}),e.jsx(E,{variant:"transparent",color:"red",onClick:()=>{o("viewDocumentApproval"),n("confirmDeleteDocumentApproval")},title:"Delete Document Approval",ml:12,children:e.jsx(P,{size:18})})]})]})]})}),e.jsx(xe,{documentApprovalId:s==null?void 0:s.document_approval_id})]})};function De(){const{post:s,processing:t}=M();return{restoreVersion:n=>{s(route("document.restore_version",{version:n}),{onSuccess:()=>{w.show({message:"Document version restored successfully.",color:"green"})},onError:()=>{w.show({message:"Failed to restore document version.",color:"red"})}})},processing:t}}function Ue(){const{delete:s,processing:t}=M();return{deleteVersion:n=>{s(route("document.delete_version",{version:n}),{onSuccess:()=>{w.show({message:"Document version deleted successfully.",color:"green"})},onError:()=>{w.show({message:"Failed to delete document version.",color:"red"})}})},processing:t}}const we=({versions:s})=>{const{restoreVersion:t}=De(),{deleteVersion:o}=Ue();return e.jsx(W,{columns:[{accessor:"name",title:"Name"},{accessor:"uploaded_at",title:"Uploaded At"},{accessor:"actions",title:"Actions",render:n=>e.jsxs(C,{gap:4,children:[e.jsx(E,{variant:"subtle",onClick:()=>t(n.id),children:e.jsx(ue,{size:16})}),e.jsx(E,{variant:"subtle",color:"red",onClick:()=>o(n.id),children:e.jsx(P,{size:16})}),e.jsx("a",{href:n.file_path,download:!0,children:e.jsx(E,{variant:"subtle",children:e.jsx(ce,{size:16})})})]})}],records:s,highlightOnHover:!0,verticalSpacing:"sm",horizontalSpacing:"sm"})};function Ae(s){const{data:t,post:o,reset:n,processing:a,errors:c,clearErrors:l}=M({document_item_id:s,file:null});return{uploadVersion:p=>{if(!p){w.show({message:"No file selected.",color:"red"});return}t.file=p,o(`/document/${s}/versions`,{onSuccess:()=>{w.show({message:"Document version uploaded successfully.",color:"green"}),n()},onError:()=>{w.show({message:"Failed to upload document version.",color:"red"})},onFinish:()=>{l()}})},processing:a,errors:c}}const Je=({document:s,itemAncestors:t,activityLog:o})=>{const{openModal:n}=T(),{uploadVersion:a,processing:c,errors:l}=Ae(s.item_id),A=p=>{p&&a(p)};return e.jsxs(oe,{children:[e.jsx(ee,{title:"Document Properties"}),e.jsx(se,{px:8,py:8,mb:48,children:e.jsx(te,{ancestors:t})}),e.jsxs(O,{children:[e.jsx(O.Col,{span:8,children:e.jsxs(N,{px:8,py:8,gap:48,mb:48,children:[e.jsxs(C,{children:[e.jsx(ie,{size:56,stroke:1,color:"gray"}),e.jsx(v,{fw:500,children:s.name})]}),e.jsxs(C,{justify:"space-between",w:700,children:[e.jsxs("div",{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Document ID"}),e.jsx(v,{size:"sm",children:s.item_id})]}),e.jsxs("div",{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Date"}),e.jsx(v,{size:"sm",children:s.created_at})]}),e.jsxs("div",{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Document Number"}),e.jsx(v,{size:"sm",children:s.document_number})]})]}),e.jsxs(N,{gap:12,children:[s.versions.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"sm",fw:"bold",children:"Document Versions"}),e.jsx(we,{versions:s.versions})]}),e.jsx(v,{size:"sm",fw:"bold",children:"Audit Log"}),e.jsx(W,{textSelectionDisabled:!0,columns:[{accessor:"date"},{accessor:"time"},{accessor:"user_name",title:"User"},{accessor:"description",title:"Action"}],records:o,highlightOnHover:!0,verticalSpacing:"lg",horizontalSpacing:"xl",withTableBorder:!0})]})]})}),e.jsx(O.Col,{span:3,offset:1,children:e.jsxs(re,{withBorder:!0,p:20,children:[e.jsx(v,{c:"dimmed",fw:500,children:"Options"}),e.jsx(J,{onChange:A,children:p=>e.jsx(S,{...p,variant:"subtle",color:"blue.5",fullWidth:!0,justify:"left",leftSection:e.jsx(ne,{size:18}),children:"Upload New Version"})}),e.jsxs(S,{variant:"subtle",color:"blue.5",leftSection:e.jsx(le,{size:18}),fullWidth:!0,justify:"left",onClick:()=>{n(s.document_approval_id?"viewDocumentApproval":"createDocumentApproval")},children:[s.document_approval_id?"View":"Start"," Approval Process"]}),e.jsx(S,{variant:"subtle",component:"a",href:route("document.view",{document:s.item_id}),target:"_blank",color:"blue.5",leftSection:e.jsx(pe,{size:18}),justify:"left",fullWidth:!0,children:"View Document"})]})})]}),e.jsx(he,{document:s}),e.jsx(je,{document:s})]})};export{Je as default};
