import{b as z,W as X,a as v,j as e,M as Z,L as ee,n as F,Y as ae,y as te}from"./app-CGxvGAM1.js";import{Y as re}from"./index-CbBGt6-f.js";import{u as N,a as oe,b as se,A as ne}from"./Authenticated-BM-HvEcH.js";import{u as le,a as de}from"./use-search-datatable-CkHI4L8G.js";import{u as ie,I as ce}from"./use-fetch-existing-metadata-column-CuGYxgXo.js";import{F as C,T as A}from"./OfficeLogo-Ei--AZU7.js";import{A as ue,I as pe}from"./IconAlertCircle-CH5cb-Yy.js";import{S as P}from"./Stack-ln4g7GYx.js";import{G as E,A as me,c as he}from"./NotificationMenu-D5SqgbTn.js";import{S as M}from"./Select-BjHhz6di.js";import{B as S}from"./Button-Bl7kfwvE.js";import{S as O}from"./StateBadge-CrSGg92W.js";import{u as ge}from"./use-document-properties-C6zsswvn.js";import{D as L}from"./DatePickerInput-DNaPhGha.js";import{I as xe}from"./IconFilter-u8ZexTpy.js";import{I as fe}from"./IconDownload-lhMm_WmO.js";import"./Checkbox-BP2ZstwZ.js";import"./IconUser-CqDa0PVn.js";import"./InputBase-QTu-g5X8.js";import"./use-uncontrolled-BIgloZcw.js";import"./CheckIcon-DXgJ84kg.js";import"./Popover-CLWfF2EQ.js";import"./TextInput-5pqGPHQ7.js";import"./get-sorted-breakpoints-BejK4YDM.js";import"./OptionsDropdown-C5Zz8uUU.js";import"./Combobox-BABC9p8O.js";import"./Badge-B2ChaLEi.js";import"./clamp-DTmYCdls.js";function ve(){return{generateReport:async g=>{var d;try{const s=await z.post(route("report.generate"),{folder_item_id:g}),{url:p,filename:u}=s.data;if(p){const o=document.createElement("a");o.href=p,o.download=u,document.body.appendChild(o),o.click(),document.body.removeChild(o)}else console.error("No URL returned for the report.")}catch(s){console.error("Error generating report:",((d=s.response)==null?void 0:d.data)||s.message)}},generateDashboardReport:async g=>{var d;try{const s=await z.post(route("report.generateDashboard"),g),{url:p,filename:u}=s.data;if(p){const o=document.createElement("a");o.href=p,o.download=u,document.body.appendChild(o),o.click(),document.body.removeChild(o)}else console.error("No URL returned for the dashboard report.")}catch(s){console.error("Error generating dashboard report:",((d=s.response)==null?void 0:d.data)||s.message)}}}}const je=({availableMetadata:h,existingMetadataIds:i})=>{const{modals:g,closeModal:d}=N(),s=g.selectDashboardMetadataColumns,{existingMetadataColumns:p,loading:u,error:o}=ie({folderId:"",isOpen:s}),{data:l,setData:m,post:x,processing:D,errors:w,reset:j}=X({metadata_columns:[{id:Date.now(),value:""}],metadata_ids:[]});v.useEffect(()=>{if(i.length>0){const n=i.map(r=>({id:Date.now()+r,value:r.toString()}));m("metadata_columns",n)}},[i,s]),v.useEffect(()=>{const n=l.metadata_columns.map(r=>parseInt(r.value)).filter(r=>!isNaN(r));m("metadata_ids",n)},[l.metadata_columns]);const b=()=>{m("metadata_columns",[...l.metadata_columns,{id:Date.now(),value:""}])},y=n=>{m("metadata_columns",l.metadata_columns.filter(r=>r.id!==n))},k=(n,r)=>{const I=l.metadata_columns.map(_=>_.id===n?{..._,value:r}:_);m("metadata_columns",I)},T=n=>{n.preventDefault(),l.metadata_columns.map(r=>parseInt(r.value)).filter(r=>!isNaN(r)),x(route("dashboard.selectMetadataColumn"),{preserveScroll:!0,onSuccess:()=>{d("selectDashboardMetadataColumns"),F.show({title:"Success",message:"Metadata columns selected successfully",color:"green"}),j()},onError:()=>{F.show({title:"Error",message:"Failed to select metadata columns",color:"red"})}})};return e.jsx(Z,{opened:s,onClose:()=>{d("selectDashboardMetadataColumns"),j()},title:"Select Metadata Columns",size:550,children:u?e.jsx(C,{justify:"center",align:"center",h:"100%",children:e.jsx(ee,{})}):o?e.jsx(ue,{icon:e.jsx(pe,{size:16}),title:"Error",color:"red",children:o}):e.jsxs("form",{onSubmit:T,children:[e.jsxs(P,{gap:16,children:[e.jsx(A,{children:"Select the metadata columns you want to display in the dashboard report:"}),l.metadata_columns.map(n=>e.jsxs(E,{justify:"space-between",align:"flex-end",children:[e.jsx(M,{placeholder:"Pick a metadata column",data:h.map(r=>({value:r.metadata_id.toString(),label:r.name})),value:n.value,onChange:r=>k(n.id,r||""),w:"90%",required:!0}),l.metadata_columns.length>1&&e.jsx(me,{color:"red",variant:"subtle",onClick:()=>y(n.id),children:e.jsx(oe,{size:18})})]},n.id)),e.jsx(C,{justify:"flex-start",children:e.jsx(S,{variant:"subtle",color:"blue.5",leftSection:e.jsx(se,{size:18}),onClick:b,children:"Add New Column"})})]}),e.jsxs(C,{align:"center",justify:"end",mt:16,children:[e.jsx(S,{variant:"outline",onClick:()=>{d("selectDashboardMetadataColumns"),j()},children:"Cancel"}),e.jsx(S,{ml:12,type:"submit",loading:D,children:"Save"})]})]})})};function Je({documents:h,filters:i,selectedMetadata:g,availableMetadata:d,existingMetadataIds:s,users:p}){const[u,o]=v.useState(i.document_status),[l,m]=v.useState(i.start_date?new Date(i.start_date):null),[x,D]=v.useState(i.end_date?new Date(i.end_date):null),[w,j]=v.useState(null),[b,y]=v.useState(null),{openDocument:k}=ge(),{search:T,setSearch:n,handleSearch:r}=le("","/dashboard/reports"),{page:I,setPage:_,handlePageChange:Se}=de(h.current_page),{generateDashboardReport:q}=ve(),{openModal:G}=N(),f=a=>{const t={document_status:u,start_date:l?l.toISOString().split("T")[0]:null,end_date:x?x.toISOString().split("T")[0]:null,uploader:w||void 0,due_in:b||void 0,page:I||void 0,...a};Object.keys(t).forEach(c=>{(t[c]===null||t[c]===void 0)&&delete t[c]}),te.get(route("dashboard.reports"),t,{replace:!0,preserveState:!0})},U=a=>{o(a),f({document_status:a,page:1})},B=a=>{m(a),f({start_date:a?a.toISOString().split("T")[0]:null,page:1})},Y=a=>{D(a),f({end_date:a?a.toISOString().split("T")[0]:null,page:1})},$=a=>{j(a),f({uploader:a,page:1})},H=a=>{y(a),f({due_in:a,page:1})},V=a=>{_(a),f({page:a})},W=()=>{const a={document_status:u,start_date:l?l.toISOString().split("T")[0]:null,end_date:x?x.toISOString().split("T")[0]:null,uploader:w,due_in:b,metadata_ids:s};q(a)},J=()=>{o(null),m(null),D(null),j(null),y(null),n(""),f({document_status:null,start_date:null,end_date:null,uploader:null,due_in:null})},K=()=>g.map(a=>a.name.toLowerCase()==="review status"?{accessor:"review_status",title:"Review Status",render:({review_status:t})=>e.jsx(O,{state:t})}:a.name.toLowerCase()==="approval status"?{accessor:"approval_status",title:"Approval Status",render:({approval_status:t})=>e.jsx(O,{state:t})}:a.name.toLowerCase()==="due_in"?{accessor:"due_in",title:"Due in",render:({due_in:t})=>t!=null?t<0?e.jsxs(A,{color:"red",size:"sm",children:[Math.abs(t)," days overdue"]}):e.jsx(A,{size:"sm",children:`${t} day${t!==1?"s":""} remaining`}):"Deadline not set"}:{accessor:`metadata_${a.metadata_id}`,title:a.name,render:t=>{var R;const c=(R=t.metadata)==null?void 0:R.find(Q=>Q.metadata_id===a.metadata_id);return c?c.value:"N/A"}});return e.jsxs(ne,{children:[e.jsx(ae,{title:"Dashboard Report"}),e.jsxs(P,{px:8,gap:24,py:8,children:[e.jsx(E,{children:e.jsx(A,{component:"h2",size:"xl",color:"gray.8",children:"Dashboard Report"})}),e.jsxs(P,{children:[e.jsxs(E,{align:"flex-end",children:[e.jsxs(C,{gap:"md",justify:"flex-start",align:"flex-end",direction:"row",wrap:"wrap",children:[e.jsx(M,{placeholder:"Select document status",value:u,onChange:U,data:[{value:"reviewal_accepted",label:"Review Accepted"},{value:"reviewal_rejected",label:"Review Rejected"},{value:"reviewal_pending",label:"Review Pending"},{value:"approval_accepted",label:"Approval Accepted"},{value:"approval_rejected",label:"Approval Rejected"},{value:"approval_pending",label:"Approval Pending"}],style:{width:200}}),e.jsx(M,{placeholder:"Select uploader",value:w,onChange:$,data:p.map(a=>({value:a.id.toString(),label:a.name})),style:{width:200}}),e.jsx(M,{placeholder:"Select due in",value:b,onChange:H,data:[{value:"7",label:"Due in 7 days"},{value:"30",label:"Due in 30 days"},{value:"60",label:"Due in 60 days"}],style:{width:200}}),e.jsx(L,{placeholder:"Start Date",value:l,onChange:B,style:{width:200},required:!0}),e.jsx(L,{placeholder:"End Date",value:x,onChange:Y,style:{width:200},required:!0}),e.jsx(S,{onClick:()=>G("selectDashboardMetadataColumns"),leftSection:e.jsx(ce,{size:16}),variant:"subtle",color:"dark.5",children:"Columns"})]}),e.jsxs(C,{gap:"sm",children:[e.jsx(S,{onClick:J,variant:"subtle",color:"gray",leftSection:e.jsx(xe,{size:16}),children:"Clear Filters"}),e.jsx(S,{onClick:W,leftSection:e.jsx(fe,{size:16}),color:"blue",variant:"subtle",children:"Generate Report"})]})]}),e.jsx(je,{availableMetadata:d,existingMetadataIds:s}),e.jsx(re,{columns:[{accessor:"name",render:({mime:a,type:t,name:c,missing_required_metadata:R})=>e.jsxs(E,{align:"center",gap:12,children:[e.jsx(he,{mime:a??"",isFolder:t==="folder",missingRequiredMetadata:R}),e.jsx("span",{children:c})]})},{accessor:"updated_at",title:"Last Modified"},...K()],records:h.data,totalRecords:h.total,recordsPerPage:h.per_page,page:I,onPageChange:V,highlightOnHover:!0,verticalSpacing:"lg",horizontalSpacing:"xl",customRowAttributes:({type:a,id:t})=>({onDoubleClick:c=>{c.button===0&&k(t)}})})]})]})]})}export{Je as default};
